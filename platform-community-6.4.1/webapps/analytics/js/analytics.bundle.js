define((()=>(()=>{"use strict";var t={d:(e,r)=>{for(var i in r)t.o(r,i)&&!t.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:r[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};t.r(e),t.d(e,{init:()=>h});var r=function(){var t=this,e=t._self._c;return e("v-app",{staticClass:"analytics-application",attrs:{id:t.appId,flat:""}},[t.canEdit?[e("analytics-chart-setting",{ref:"chartSettingDialog",staticClass:"mt-0",attrs:{"retrieve-mappings-url":t.retrieveMappingsUrl,settings:t.chartSettings},on:{save:t.saveSettings}}),t._v(" "),e("analytics-json-panel-dialog",{ref:"jsonPanelDialog",staticClass:"mt-0",attrs:{settings:t.chartSettings}}),t._v(" "),e("analytics-view-samples-drawer",{ref:"viewSamplesDrawer",staticClass:"mt-0",attrs:{title:t.$t(t.title),"selected-period":t.selectedPeriod,"retrieve-samples-url":t.retrieveChartSamplesUrl}})]:t._e(),t._v(" "),e("v-card",{staticClass:"ma-auto analytics-chart-parent white",attrs:{flat:""}},[e("div",{staticClass:"d-flex pa-3 analytics-chart-header",attrs:{flat:""}},[e("v-toolbar-title",{staticClass:"d-flex"},[e("v-tooltip",{attrs:{bottom:""},scopedSlots:t._u([{key:"activator",fn:function({on:r,attrs:i}){return[e("v-btn",t._g(t._b({staticClass:"my-auto me-2 primary",attrs:{height:"20",width:"20",icon:"",small:"",outlined:""}},"v-btn",i,!1),r),[e("v-icon",{attrs:{size:"12"}},[t._v("fa-info")])],1)]}}])},[t._v(" "),e("span",[e("div",[t._v("- "+t._s(t.$t("analytics.dataRestriction"))+": "+t._s(t.scopeTooltip))]),t._v(" "),e("div",[t._v("- "+t._s(t.$t("analytics.totalSamplesCount"))+": "+t._s(t.chartsData.dataCount))]),t._v(" "),e("div",[t._v("- "+t._s(t.$t("analytics.computingTime"))+": "+t._s(t.chartsData.computingTime)+" ms")])])]),t._v(" "),e("div",{staticClass:"my-auto subtitle-1 text-truncate analytics-chart-title",attrs:{title:t.title}},[t._v("\n          "+t._s(t.$t(t.title))+"\n        ")])],1),t._v(" "),e("v-spacer"),t._v(" "),e("analytics-select-period",{model:{value:t.selectedPeriod,callback:function(e){t.selectedPeriod=e},expression:"selectedPeriod"}}),t._v(" "),t.canEdit?e("v-menu",{attrs:{"offset-y":""},scopedSlots:t._u([{key:"activator",fn:function({on:r}){return[e("v-btn",t._g({staticClass:"ml-2",attrs:{icon:""},on:{blur:function(e){return t.closeMenu()}}},r),[e("v-icon",[t._v("mdi-dots-vertical")])],1)]}}],null,!1,859802859),model:{value:t.showMenu,callback:function(e){t.showMenu=e},expression:"showMenu"}},[t._v(" "),e("v-list",[e("v-list-item",{on:{mousedown:function(t){return t.preventDefault()},click:function(e){return t.$refs.viewSamplesDrawer.open()}}},[e("v-list-item-title",[t._v(t._s(t.$t("analytics.samples")))])],1),t._v(" "),e("v-list-item",{on:{mousedown:function(t){return t.preventDefault()},click:function(e){return t.$refs.chartSettingDialog.open()}}},[e("v-list-item-title",[t._v(t._s(t.$t("analytics.settings")))])],1),t._v(" "),e("v-list-item",{on:{mousedown:function(t){return t.preventDefault()},click:function(e){return t.$refs.jsonPanelDialog.open()}}},[e("v-list-item-title",[t._v(t._s(t.$t("analytics.jsonSettings")))])],1)],1)],1):t._e()],1),t._v(" "),t.loading?e("v-card-title",{staticClass:"ma-auto",attrs:{"primary-title":""}},[e("v-spacer"),t._v(" "),e("v-progress-circular",{attrs:{color:"primary",indeterminate:"",size:"20"}}),t._v(" "),e("v-spacer")],1):t._e(),t._v(" "),e("analytics-chart",{ref:"analyticsChartBody",attrs:{title:t.title,"chart-type":t.chartType,colors:t.colors}})],1)],2)};function i(t,e,r,i,a,n,s,l){var o,c="function"==typeof t?t.options:t;if(e&&(c.render=e,c.staticRenderFns=r,c._compiled=!0),i&&(c.functional=!0),n&&(c._scopeId="data-v-"+n),s?(o=function(t){(t=t||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(t=__VUE_SSR_CONTEXT__),a&&a.call(this,t),t&&t._registeredComponents&&t._registeredComponents.add(s)},c._ssrRegister=o):a&&(o=l?function(){a.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:a),o)if(c.functional){c._injectStyles=o;var h=c.render;c.render=function(t,e){return o.call(e),h(t,e)}}else{var u=c.beforeCreate;c.beforeCreate=u?[].concat(u,o):[o]}return{exports:t,options:c}}r._withStripped=!0;const a=i({props:{retrieveSettingsUrl:{type:String,default:function(){return null}},retrieveMappingsUrl:{type:String,default:function(){return null}},retrieveFiltersUrl:{type:String,default:function(){return null}},retrieveChartDataUrl:{type:String,default:function(){return null}},retrieveChartSamplesUrl:{type:String,default:function(){return null}},saveSettingsUrl:{type:String,default:function(){return null}}},data:()=>({canEdit:!1,error:null,scope:null,title:null,chartType:"line",initialized:!1,showMenu:!1,displaySamplesCount:!1,selectedPeriod:null,loading:!0,appId:`AnalyticsApplication${parseInt(1e4*Math.random()).toString().toString()}`,chartsData:{},chartSettings:null,DEFAULT_COLORS:["#319ab3","#f97575","#98cc81","#4273c8","#cea6ac","#bc99e7","#9ee4f5","#774ea9","#ffa500","#bed67e","#bc99e7","#ffaacc"]}),computed:{scopeTooltip(){switch(this.scope){case"NONE":return this.$t("analytics.permissionDenied");case"GLOBAL":return this.$t("analytics.noDataRestriction");case"USER":return this.$t("analytics.dataRestrictedToCurrentUser");case"SPACE":return this.$t("analytics.dataRestrictedToCurrentSpace")}return this.error},colors(){return this.chartSettings&&this.chartSettings.colors&&this.chartSettings.colors.length&&this.chartSettings.colors.slice()||this.DEFAULT_COLORS}},watch:{selectedPeriod(t,e){e||!t||this.initialized?t&&this.updateChart():(this.initialized=!0,this.init())}},methods:{init(){return this.loading=!0,this.getSettings().then(this.$nextTick).then(this.updateChart).then(this.$nextTick).then(this.getFilters).finally((()=>{this.loading=!1}))},getSettings(){return fetch(this.retrieveSettingsUrl,{method:"GET",credentials:"include"}).then((t=>{if(t&&t.ok)return t.json();throw new Error(`Error getting analytics of chart '${this.title}'`)})).then((t=>{this.chartSettings||(this.chartSettings=t),this.scope=t&&t.scope,this.canEdit=t&&t.canEdit,this.chartType=t&&t.chartType,this.title=t&&t.title||this.$t("analytics.chartDataPlaceholder")})).catch((t=>{console.error("Error retrieving chart filters",t),this.error="Error retrieving chart filters"}))},getFilters(){if(this.canEdit)return fetch(this.retrieveFiltersUrl,{method:"GET",credentials:"include"}).then((t=>{if(t&&t.ok)return t.json();throw new Error(`Error getting analytics of ${JSON.stringify(this.settings)}`)})).then((t=>{this.chartSettings=t,t||(this.chartSettings={filters:[],aggregations:[]}),this.chartSettings.filters||(this.chartSettings.filters=[]),this.chartSettings.xAxisAggregations||(this.chartSettings.xAxisAggregations=[]),this.chartSettings.yAxisAggregation||(this.chartSettings.yAxisAggregation={})})).catch((t=>{console.error("Error retrieving chart filters",t),this.error="Error retrieving chart filters"}))},saveSettings(t){return this.loading=!0,fetch(this.saveSettingsUrl,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:$.param({settings:JSON.stringify(t)})}).then((e=>{if(!e||!e.ok)throw new Error("Error saving chart settings",t);return this.chartSettings=JSON.parse(JSON.stringify(t)),this.init()})).catch((t=>{console.error("Error saving chart settings",t),this.error="Error saving chart settings"})).finally((()=>{this.loading=!1}))},updateChart(){if(!this.selectedPeriod)return;this.loading=!0;const t={lang:eXo.env.portal.language&&eXo.env.portal.language.replace("_","-"),min:this.selectedPeriod.min,max:this.selectedPeriod.max+6e4,timeZone:this.$analyticsUtils.USER_TIMEZONE_ID};return fetch(this.retrieveChartDataUrl,{method:"POST",credentials:"include",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:$.param(t)}).then((t=>{if(t&&t.ok)return t.json();throw new Error("Error getting analytics with settings:",this.chartSettings)})).then((t=>{this.chartsData=t,this.$refs.analyticsChartBody.init(this.chartsData)})).catch((t=>{console.error("fetch analytics - error",t),this.error="Error getting analytics"})).finally((()=>this.loading=!1))},closeMenu(){this.showMenu=!1}}},r,[],!1,null,null,null).exports;var n=function(){return(0,this._self._c)("v-flex",{staticClass:"analytics-chart-body",attrs:{id:this.id}})};n._withStripped=!0;const s={"analytics-application":a,"analytics-chart":i({props:{chartType:{type:String,default:function(){return"line"}},title:{type:String,default:function(){return null}},colors:{type:Array,default:function(){return["#319ab3","#f97575","#98cc81","#4273c8","#cea6ac","#bc99e7","#9ee4f5","#774ea9","#ffa500","#bed67e","#bc99e7","#ffaacc"]}}},data:()=>({id:`Chart${parseInt(1e4*Math.random()).toString().toString()}`}),watch:{data(){this.init()}},methods:{init(t){const e=t&&t.charts||[],r=t&&t.labels||[],i=$(`#${this.id}`);if(!i.length)return void console.error("No chart container for selector",this.id);const a=[],n={title:{x:"center"},grid:{top:0,left:30,bottom:30},color:this.colors,series:a};if("line"===this.chartType||"bar"===this.chartType){const t={type:"value",splitLine:{show:!1}};Object.assign(n,{grid:{show:!1},tooltip:{trigger:"axis",axisPointer:{type:"cross",label:{backgroundColor:"#6a7985"}}},xAxis:[{type:"category",showGrid:!1,data:r,splitLine:{show:!1}}],yAxis:[t]}),"line"===this.chartType?n.xAxis[0].boundaryGap=!1:n.xAxis[0].axisTick={alignWithLabel:!0},1!==e.length||e[0].chartLabel&&"null"!==e[0].chartLabel||(n.tooltip.formatter="{b}<br/><center>{c}</center>");const i=e&&e.length>1;e.forEach((e=>{const r={type:this.chartType,data:e.values,smooth:.2,showSymbol:!1};if(i||(r.areaStyle={opacity:.8},r.lineStyle={width:1}),e.chartLabel&&(r.name=this.getI18N(e.chartLabel)),a.push(r),e.values&&e.values.length){const r=Math.min(...e.values);(!t.min||r<t.min)&&(t.min=r||0);const i=Math.max(...e.values);(!t.max||i>t.max)&&(t.max=i||0)}})),t.min||(t.min=0),t.max||(t.max=0),t.max=t.max+parseInt((t.max-t.min)/10)+1,t.min=t.min-parseInt((t.max-t.min)/10),t.min>1&&(t.min-=1)}else if("pie"===this.chartType){n.tooltip={trigger:"item",formatter:"{b} : {c} ({d}%)"},n.legend={orient:"vertical",left:"2%"};const t=e.length,r=parseInt((t+1)/2)+1,i=parseInt(100/r);e.forEach(((e,n)=>{const s=e.aggregationResults.map((t=>{const e={value:t.result};return t.label&&(e.name=this.getI18N(t.label)),e})).sort(((t,e)=>parseFloat(e.value)-parseFloat(t.value))),l=1.25*parseInt((parseInt(n/(r-1))+1)*i),o=parseInt((parseInt(n%(r-1))+1)*i),c={type:this.chartType,radius:`${i+5}%`,center:[`${l}%`,`${o}%`],label:{show:!1,position:"center"},data:s,itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)",label:{show:!0,fontSize:"15"}}}};let h;h=s&&s.length<=10?"50%":s&&s.length>10&&s.length<=20?"65%":"80%",1===t&&(c.radius=["40%","70%"],c.center=[h,"45%"]),c.name=e.chartLabel,a.push(c)}))}echarts.init(i[0]).setOption(n,!0)},getI18N(t){const e=t.split("=")[1];if(e){const t=`analytics.${e}`,r=this.$t(t);return r===t?e:r}return t}}},n,[],!1,null,null,null).exports};for(const t in s)Vue.component(t,s[t]);Vue.use(Vuetify);const l=new Vuetify(eXo.env.portal.vuetifyPreset),o=eXo&&eXo.env&&eXo.env.portal&&eXo.env.portal.language||"en",c=`${eXo.env.portal.context}/${eXo.env.portal.rest}/i18n/bundle/locale.portlet.Analytics-${o}.json`;function h(t){exoi18n.loadLanguageAsync(o,c).then((e=>{const r=$(`#${t}`),i=r.attr("data-settings-url"),a=r.attr("data-mappings-url"),n=r.attr("data-filters-url"),s=r.attr("data-chart-data-url"),o=r.attr("data-chart-samples-url"),c=r.attr("data-field-values-url"),h=r.attr("data-save-settings-url");new Vue({data:()=>({retrieveSettingsURL:i,retrieveMappingsURL:a,retrieveFiltersURL:n,retrieveChartDataURL:s,retrieveChartSamplesURL:o,retrieveFieldValuesUrl:c,saveSettingsURL:h}),mounted(){document.dispatchEvent(new CustomEvent("hideTopBarLoading"))},template:`\n        <analytics-application\n           id="${t}"\n           :retrieve-settings-url="retrieveSettingsURL"\n           :retrieve-mappings-url="retrieveMappingsURL"\n           :retrieve-filters-url="retrieveFiltersURL"\n           :retrieve-chart-data-url="retrieveChartDataURL"\n           :retrieve-chart-samples-url="retrieveChartSamplesURL"\n           :retrieve-field-values-url="retrieveFieldValuesUrl"\n           :save-settings-url="saveSettingsURL"\n           data-id="${t}"\n           data-settings-url="${i}"\n           data-mappings-url="${a}"\n           data-filters-url="${n}"\n           data-chart-data-url="${s}"\n           data-chart-samples-url="${o}"\n           data-field-values-url="${c}"\n           data-save-settings-url="${h}" />`,vuetify:l,i18n:e}).$mount(`#${t}`)}))}return document.dispatchEvent(new CustomEvent("displayTopBarLoading")),e})()));