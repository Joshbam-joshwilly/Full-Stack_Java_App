define((()=>(()=>{"use strict";var e={d:(t,r)=>{for(var s in r)e.o(r,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:r[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{formatSearchResult:()=>Z});var r=function(){var e=this,t=e._self._c;return t("v-flex",{staticClass:"contactAutoComplete",attrs:{id:e.id}},[t("v-autocomplete",{ref:"selectAutoComplete",staticClass:"contactAutoComplete",attrs:{rules:e.rules,items:e.items,loading:e.isLoadingSuggestions,"search-input":e.searchTerm,label:e.inputLabel,disabled:e.disabled,placeholder:e.inputPlaceholder,"content-class":`contactAutoCompleteContent ${e.bigField&&"bigContactAutoComplete"}`,filter:e.filterIgnoredItems,multiple:e.multiple,required:e.required,"max-width":"100%","item-text":"name","item-value":"id_type","hide-details":"","hide-selected":"",chips:"","cache-items":"",dense:"",flat:""},on:{"update:searchInput":function(t){e.searchTerm=t},"update:search-input":[function(t){e.searchTerm=t},function(t){e.searchTerm=t}],click:function(e){e.stopPropagation()}},scopedSlots:e._u([{key:"selection",fn:function({item:r,selected:s}){return[r.avatar?t("v-chip",{staticClass:"autocompleteSelectedItem",attrs:{"input-value":s,title:"error"===e.addressLoad?e.$t("exoplatform.perkstore.warning.recipientDoesntHaveWallet"):""},on:{"update:active":function(t){return e.selectSingleItem(r)}}},["loading"===e.addressLoad?t("v-progress-circular",{staticClass:"me-2",attrs:{indeterminate:"",color:"white"}}):"error"===e.addressLoad?t("v-icon",{staticClass:"me-2",attrs:{alt:"Invalid address",color:"red",size:"15"}},[e._v("\n          warning\n        ")]):e._e(),e._v(" "),t("span",[e._v("\n          "+e._s(r.name)+"\n          "),t("a",{staticClass:"remove",attrs:{href:"#",title:e.$t("exoplatform.perkstore.button.delete")},on:{click:function(t){return e.remove(r)}}},[t("i",{staticClass:"uiIconClose uiIconLightGray"})])])],1):t("v-label",{staticClass:"black--text",attrs:{selected:s,solo:""},on:{input:function(t){return e.selectSingleItem(r)}}},[e._v("\n        "+e._s(r.name)+"\n        "),t("a",{staticClass:"remove",attrs:{href:"#"}},[t("i",{staticClass:"uiIconClose uiIconLightGray"})])])]}},{key:"item",fn:function(r){return["object"!=typeof r.item?[t("v-list-item-content",{domProps:{textContent:e._s(r.item)}})]:r.item.avatar?t("v-list-item-avatar",{attrs:{size:"20"}},[t("img",{attrs:{src:r.item.avatar}})]):e._e(),e._v(" "),t("v-list-item-title",{domProps:{textContent:e._s(r.item.name)}})]}}]),model:{value:e.selectedValue,callback:function(t){e.selectedValue=t},expression:"selectedValue"}},[t("template",{slot:"no-data"},[t("v-list-item",[e.noDataLabel?t("v-list-item-title",[e._v("\n          "+e._s(e.noDataLabel)+"\n        ")]):t("v-list-item-title",[e._v("\n          "+e._s(e.$t("exoplatform.perkstore.label.autocompletePlaceholder"))+"\n        ")])],1)],1)],2)],1)};function s(e,t){return fetch(`/portal/rest/wallet/api/account/detailsById?id=${e}&type=${t}`,{credentials:"include"}).then((e=>e&&e.ok?e.json():null))}function i(e,t,r,s,i,a,o,l){var n,d="function"==typeof e?e.options:e;if(t&&(d.render=t,d.staticRenderFns=r,d._compiled=!0),s&&(d.functional=!0),a&&(d._scopeId="data-v-"+a),o?(n=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),i&&i.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(o)},d._ssrRegister=n):i&&(n=l?function(){i.call(this,(d.functional?this.parent:this).$root.$options.shadowRoot)}:i),n)if(d.functional){d._injectStyles=n;var c=d.render;d.render=function(e,t){return n.call(t),c(e,t)}}else{var u=d.beforeCreate;d.beforeCreate=u?[].concat(u,n):[n]}return{exports:e,options:d}}r._withStripped=!0;const a=i({props:{rules:{type:Array,default:function(){return[]}},required:{type:Boolean,default:function(){return!1}},inputLabel:{type:String,default:function(){return null}},inputPlaceholder:{type:String,default:function(){return null}},noDataLabel:{type:String,default:function(){return null}},noAddress:{type:Boolean,default:function(){return!1}},onlyUsers:{type:Boolean,default:function(){return!1}},multiple:{type:Boolean,default:function(){return!1}},disabled:{type:Boolean,default:function(){return!1}},bigField:{type:Boolean,default:function(){return!1}},ignoreItems:{type:Array,default:function(){return[]}}},data:()=>({items:[],id:`AutoComplete${parseInt(1e4*Math.random()).toString().toString()}`,selectedValue:null,searchTerm:null,address:null,isLoadingSuggestions:!1,addressLoad:"",currentUserItem:null,error:null}),watch:{searchTerm(e){if(e&&e.length)return this.isLoadingSuggestions=!0,function(e,t){let r=null;return function(e,t){const r=$.param({nameToSearch:e,typeOfRelation:"mention_activity_stream",currentUser:eXo.env.portal.userName,spaceURL:window.perkStoreSettings&&window.perkStoreSettings.accessPermission&&window.perkStoreSettings.accessPermission.length?window.perkStoreSettings.accessPermission:null});return fetch(`/portal/rest/social/people/suggest.json?${r}`,{credentials:"include"}).then((e=>e.ok?e.json():null)).then((e=>(e?(e.options&&(e=e.options),e.forEach((e=>{e.id&&0===e.id.indexOf("@")&&(e.id=e.id.substring(1),e.id_type=`user_${e.id}`,e.avatar||(e.avatar=e.avatarUrl?e.avatarUrl:`/rest/v1/social/users/${e.id}/avatar`))}))):e=[],e)))}(e).then((e=>r=e&&e.length?e:[])).then((()=>t&&[]||function(e,t){const r=$.param({fields:["id","prettyName","displayName","avatarUrl"],keyword:e});return fetch(`/portal/rest/space/user/searchSpace?${r}`,{credentials:"include"}).then((e=>e.ok?e.json():null)).then((e=>{const t=[];return e.forEach((e=>{t.push({avatar:e.avatarUrl?e.avatarUrl:`/portal/rest/v1/social/spaces/${e.prettyName}/avatar`,name:e.displayName,id:e.prettyName,id_type:`space_${e.prettyName}`,technicalId:e.id,members:null})})),t}))}(e))).then((e=>r=e&&e.length?r.concat(e):r)).catch((e=>{console.error("searchContact method - error",e)}))}(e,this.onlyUsers).then((e=>{this.items=e,this.items?this.currentUserItem&&this.items.push(this.currentUserItem):this.currentUserItem?this.items=[this.currentUserItem]:this.items=[]})).finally((()=>{this.isLoadingSuggestions=!1}));this.currentUserItem?this.items=[this.currentUserItem]:this.items=[]},selectedValue(){this.$refs.selectAutoComplete.isFocused=!1,this.addressLoad="loading";const e=this.selectedValue;this.$emit("clear-selection"),e&&e.length&&(this.multiple?e.forEach((e=>this.emitSelectedValue(e))):this.emitSelectedValue(e))}},created(){s(eXo.env.portal.userName,"user").then((e=>{e&&(e.id_type=`${e.type}_${e.id}`,this.currentUserItem=e)}))},mounted(){window.addEventListener("click",(()=>{this.$refs.selectAutoComplete&&this.$refs.selectAutoComplete.blur()}))},methods:{emitSelectedValue(e){const t=e.indexOf("_")<0,r=t?null:e.substring(0,e.indexOf("_")),i=t?e:e.substring(e.indexOf("_")+1);if(!this.noAddress)return t?function(e){if(e){e=e.toLowerCase();try{const t=sessionStorage.getItem(`exo-wallet-address-user-${e}`.toLowerCase())||sessionStorage.getItem(`exo-wallet-address-space-${e}`.toLowerCase());if(t)return Promise.resolve(JSON.parse(t))}catch(e){console.error("Error getting item from session storage")}return fetch(`/portal/rest/wallet/api/account/detailsByAddress?address=${e}`,{credentials:"include"}).then((e=>e.ok?e.json():null)).then((t=>{if(t&&t.name&&t.name.length)return t.avatar||(t.avatar="user"===t.type?`/rest/v1/social/users/${t.id}/avatar`:`/rest/v1/social/spaces/${t.id}/avatar`),!t.id_type&&t.type&&t.id&&(t.id_type=`${t.type}_${t.id}`),sessionStorage.setItem(`exo-wallet-address-${t.type}-${e}`.toLowerCase(),JSON.stringify(t)),t})).catch((e=>{console.error("searchFullName method - error",e)}))}}(e).then((e=>{e&&e.type?(this.addressLoad="success",this.$emit("item-selected",{id:e.id,type:e.type,address:e.address,id_type:`${e.type}_${e.id}`})):(this.addressLoad="success",this.$emit("item-selected",{id:i,type:r,address:i}))})):function(e,t){const r=sessionStorage.getItem(`exo-wallet-address-${t}-${e}`.toLowerCase());return r?Promise.resolve(r):s(e,t).then((r=>r&&r.address&&r.address.length&&0===r.address.indexOf("0x")?(sessionStorage&&sessionStorage.setItem(`exo-wallet-address-${t}-${e}`.toLowerCase(),r.address),r.address):(sessionStorage.removeItem(`exo-wallet-address-${t}-${e}`.toLowerCase()),null)))}(i,r).then((e=>{e&&e.length?(this.addressLoad="success",this.$emit("item-selected",{id:i,type:r,address:e})):(this.addressLoad="error",this.$emit("item-selected",{id:i,type:r,address:null}))})).catch((e=>{console.error("searchAddress method - error",e),this.addressLoad="error"}));this.addressLoad="success",this.$emit("item-selected",{id:i,type:r,address:i})},clear(){this.currentUserItem?this.items=[this.currentUserItem]:this.items=[],this.selectedValue=null,this.searchTerm=null,this.address=null,this.isLoadingSuggestions=!1,this.addressLoad="",this.error=null},canAddItem(e){return!e||!e.id||this.ignoreItems.indexOf(e.id)<0},filterIgnoredItems(e,t,r){return!(t&&r.toLowerCase().indexOf(t.toLowerCase())<0)&&(!this.ignoreItems||!this.ignoreItems.length||this.canAddItem(e))},selectItems(e){e&&(e.splice?e.forEach((e=>{e&&e.id&&e.type&&this.selectSingleItem(e.id,e.type)})):e.id&&e.type&&this.selectSingleItem(e.id,e.type))},selectSingleItem(e,t){if(e){if(t)return s(e,t).then((e=>{e.id_type=e.type&&e.id?`${e.type}_${e.id}`:null,this.items.push(e),this.$refs.selectAutoComplete&&this.$refs.selectAutoComplete.selectItem(e)}));{const t={id_type:e,name:e};this.items.push(t),this.$refs.selectAutoComplete&&this.$refs.selectAutoComplete.selectItem(t)}}else this.$refs.selectAutoComplete.selectItem(null)},remove(e){if(this.selectedValue)if(this.selectedValue.splice){const t=this.selectedValue.indexOf(e.id_type);t>=0&&this.selectedValue.splice(t,1)}else this.selectedValue=null}}},r,[],!1,null,null,null).exports;var o=function(){var e=this,t=e._self._c;return t("v-form",{ref:"form",attrs:{id:"buyFormProduct"}},[t("v-container",[e.errors&&e.errors.length>0&&!e.loading?t("v-flex",{staticClass:"errorContainer"},e._l(e.errors,(function(r){return t("div",{key:r,staticClass:"alert alert-error v-content"},[t("i",{staticClass:"uiIconError"}),e._v("\n        "+e._s(r)+"\n      ")])})),0):e._e(),e._v(" "),e.product&&e.product.description?t("v-row",[t("div",{staticClass:"d-flex flex-column pl-4 pb-2"},[t("label",{staticClass:"mb-1 font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.productDescription"))+":")]),e._v(" "),t("div",{staticClass:"font-weight-regular"},[e._v(e._s(e.product.description))])])]):e._e(),e._v(" "),e.productImage?t("v-row",[t("label",{staticClass:"pl-4 pb-2 font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.Gallery")))])]):e._e(),e._v(" "),e.productImage?t("v-row",e._l(e.product.imageFiles.slice(0,3),(function(e){return t("v-col",{key:e.src,staticClass:"pl-4",attrs:{cols:"12",sm:"4"}},[t("a",{attrs:{href:e.src,target:"_blank"}},[t("v-img",{staticClass:"productImageBuyPage",attrs:{src:e.src,"aspect-ratio":"1","max-width":"200px","max-height":"100%"}})],1)])})),1):e._e(),e._v(" "),t("v-row",{staticClass:"pl-5"},[t("v-col",{attrs:{cols:"12",sm:"6"}},[t("v-row",{staticClass:"pb-3"},[t("label",{staticClass:"font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.Marchant"))+":")])]),e._v(" "),e.product&&e.product.receiverMarchand?t("v-row",{staticClass:"pb-3"},["user"===e.product.receiverMarchand.type?t("exo-user-avatar",{key:e.product.receiverMarchand.id,attrs:{"profile-id":e.product.receiverMarchand.id,size:25,"extra-class":"buyFormMarchant",popover:""}}):e._e(),e._v(" "),"space"===e.product.receiverMarchand.type?t("exo-space-avatar",{key:e.product.receiverMarchand.id,attrs:{"space-id":e.product.receiverMarchand.spaceId,size:25,"extra-class":"buyFormMarchant",popover:""}}):e._e()],1):e._e(),e._v(" "),t("v-row",[t("label",{staticClass:"font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.QuantityToBuy"))+":")])]),e._v(" "),t("v-row",[t("v-text-field",{staticClass:"text-center pt-1 quantity perkStoreTextField",attrs:{disabled:e.loading,rules:e.quantityRules,"append-icon":"fa-plus","prepend-inner-icon":"fa-minus",name:"quantity",required:""},on:{"click:prepend-inner":e.decrementQuantity,"click:append":e.incrementQuantity},model:{value:e.quantity,callback:function(t){e.quantity=e._n(t)},expression:"quantity"}})],1)],1),e._v(" "),t("v-col",{attrs:{cols:"12",sm:"6"}},[t("v-row",{staticClass:"pb-3"},[t("label",{staticClass:"font-weight-bold"},[e._v("\n            "+e._s(e.$t("exoplatform.perkstore.label.unitPrice"))+":\n          ")])]),e._v(" "),t("v-row",{staticClass:"pb-3"},[t("label",{staticClass:"font-weight-bold"},[t("span",{staticClass:"priceSymbol"},[e._v(e._s(e.symbol))]),e._v(" "+e._s(e.productPrice)+"\n          ")])]),e._v(" "),t("v-row",{staticClass:"pb-4 mt-1"},[t("label",{staticClass:"font-weight-bold"},[e._v("\n            "+e._s(e.$t("exoplatform.perkstore.label.AmountToBuy"))+":\n          ")])]),e._v(" "),t("v-row",[t("label",{staticClass:"font-weight-bold"},[t("span",{staticClass:"priceSymbol"},[e._v(e._s(e.symbol))]),e._v("  "+e._s(e.amountLabel)+"\n          ")])])],1)],1),e._v(" "),t("v-row",{staticClass:"pl-5"},[e.needPassword&&e.isInternalWallet?t("label",{staticClass:"font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.walletPassword")))]):e.isInternalWallet?e._e():t("label",{staticClass:"font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.wallet")))])]),e._v(" "),t("v-row",{staticClass:"pl-5"},[e.isInternalWallet?e._e():t("v-col",{staticClass:"d-flex align-center ml-n3",attrs:{cols:"12",sm:"6"}},[t("img",{staticClass:"mt-n1",attrs:{src:"/wallet-common/images/metamask.svg",alt:"Metamask",width:"18"}}),e._v(" "),t("span",{staticClass:"pl-2"},[e._v("Metamask :")])]),e._v(" "),e.isInternalWallet?e._e():t("v-col",{attrs:{cols:"12",sm:"6",align:"right"}},[t("v-chip",{staticClass:"grey-background"},[t("span",{staticClass:"mr-3 dark-grey-color walletTitle"},[e._v("\n            "+e._s(e.metamaskAddressPreview)+"\n          ")]),e._v(" "),t("wallet-settings-jdenticon",{attrs:{address:e.senderAddress}})],1)],1),e._v(" "),e.needPassword&&e.isInternalWallet?t("v-text-field",{staticClass:"passwordWallet pt-0",attrs:{"append-icon":e.walletPasswordShow?"mdi-eye":"mdi-eye-off",type:e.walletPasswordShow?"text":"password",disabled:e.loading,rules:e.requiredRule,placeholder:e.$t("exoplatform.perkstore.label.walletPasswordPlaceholder"),name:"walletPassword",autocomplete:"current-passord",required:"",autofocus:"",color:"grey darken-4","validate-on-blur":""},on:{"click:append":function(t){e.walletPasswordShow=!e.walletPasswordShow}},model:{value:e.walletPassword,callback:function(t){e.walletPassword=t},expression:"walletPassword"}}):e._e()],1)],1)],1)};function l(e,t){if(!e||!e.ok){const r=e&&e.headers&&e.headers.get("content-type");if(r&&-1!==r.indexOf("application/json"))return e.json().then((e=>{const r=function(e,t){return e&&e.code&&e.suffix&&e.message?e.message:t}(e,t);throw new Error(r)}))}throw new Error(t)}function n(e,t){t||(t=3);try{return Number.parseFloat(e).toFixed(t).replace(/(\..*[1-9])0+$/,"$1").replace(/\.0*$/,"")}catch(t){return console.error("Error parsing value ",e," same value will be retruned",t),e}}function d(e,t,r,s){return t=Object.assign(t||{},{productId:e||0,selectedOrderId:r,limit:s||0}),fetch("/portal/rest/perkstore/api/order/list",{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then((t=>t&&t.ok?t.json():l(t,`Error getting orders of product id : ${e}`)))}function c(e,t){return fetch("/portal/rest/perkstore/api/order/save"+(t?"Simulate":""),{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)}).then((e=>{if(!e||!e.ok)return l(e,"Error saving order")}))}function u(e,t){return delete e.modificationType,fetch(`/portal/rest/perkstore/api/order/saveStatus?modificationType=${t}`,{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)}).then((e=>e&&e.ok?e.json():l(e,"Error saving order status")))}o._withStripped=!0;const p=i({props:{product:{type:Object,default:function(){return{}}},symbol:{type:String,default:function(){return null}},opened:{type:Boolean,default:function(){return!1}},integrated:{type:Boolean,default:function(){return!1}},needPassword:{type:Boolean,default:function(){return!1}},walletEnabled:{type:Boolean,default:function(){return!1}},walletLoading:{type:Boolean,default:function(){return!1}}},data(){return{loading:!1,quantity:1,walletPassword:"",walletPasswordShow:!1,errors:[],requiredRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField")],quantityRules:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField"),e=>this.isPositiveNumber(e)||this.$t("exoplatform.perkstore.warning.invalidPositiveNumber"),e=>!this.product||this.product.unlimited||this.quantity<=this.available||this.$t("exoplatform.perkstore.warning.quantityExceedsTotalSupply",{0:this.available}),e=>!this.product||!this.product.maxOrdersPerUser||this.quantity<=this.remainingOrdersForUser||this.$t("exoplatform.perkstore.warning.quantityExceedsAllowedOrders",{0:this.remainingOrdersForUser})]}},computed:{getUrl(){if("user"===this.product.creator.type)return`${eXo.env.portal.context}/${eXo.env.portal.portalName}/profile/${this.product.creator.id}`;if(this.product.creator.spaceId&&0!==this.product.creator.spaceId){let e=this.product.creator.spaceURLId;if(e)return e=e.replace(/\//g,":"),`${eXo.env.portal.context}/g/${e}/`}return""},productImage(){return this.product&&this.product.imageFiles&&this.product.imageFiles[0]&&this.product.imageFiles[0].src},disablePayButton(){return!this.product||!this.walletEnabled||this.walletLoading||!this.quantity||this.needPassword&&!this.walletPassword||this.maxOrdersReached&&!this.product.unlimited||!this.isPositiveNumber(this.quantity)||!this.product.unlimited&&this.quantity>this.maxQuantity},amount(){return this.quantity&&this.product&&this.product.price&&n(this.product.price*this.quantity)||0},available(){if(this.product&&!this.product.unlimited){const e=this.product.totalSupply-this.product.purchased;return e>0?e:0}return 0},maxOrdersPerUser(){return this.product&&this.product.maxOrdersPerUser},purchasedOrders(){return this.product&&this.product.userData&&(this.product.orderPeriodicity?this.product.userData.purchasedInCurrentPeriod||0:this.product.userData.totalPurchased||0)},remainingOrdersForUser(){return this.maxOrdersPerUser&&this.product.userData?this.maxOrdersPerUser-this.purchasedOrders:0},productPrice(){return this.product&&this.product.price},maxOrdersRemaining(){if(this.product&&this.product.maxOrdersPerUser&&this.product.userData){const e=this.product.orderPeriodicity?this.product.userData.purchasedInCurrentPeriod||0:this.product.userData.totalPurchased||0,t=this.product.maxOrdersPerUser-e;return t>0?t:0}return this.product&&this.product.unlimited?0:this.available},maxQuantity(){return this.product&&this.product.unlimited?this.maxOrdersRemaining:Math.min(this.available,this.maxOrdersRemaining)},maxOrdersReached(){return this.product&&!this.maxQuantity},amountLabel(){return`${this.amount||0}`},limitedQuantity(){return this.product&&(this.product.maxOrdersPerUser||!this.product.unlimited)},quantityInputLabel(){return this.limitedQuantity?this.$t("exoplatform.perkstore.label.quantityWithMax",{0:this.maxQuantity}):this.$t("exoplatform.perkstore.label.quantity")},productTitle(){return this.product&&this.product.title?this.product.title:""},provider:()=>window.walletSettings.wallet.provider,isInternalWallet(){return"INTERNAL_WALLET"===this.provider},senderAddress:()=>window.walletSettings.wallet.address,contractDetails(){return this.tokenUtils.getContractDetails(this.senderAddress)},DecimalsAmount(){return this.walletUtils.convertTokenAmountToSend(this.amount,this.contractDetails.decimals)},metamaskAddressPreview(){return this.senderAddress&&`${this.senderAddress.substring(0,5)}...${this.senderAddress.substring(this.senderAddress.length-4,this.senderAddress.length)}`}},watch:{errors(){this.errors&&this.errors.length>0&&(this.loading=!1)},loading(){this.$emit("loading",this.loading)}},created(){document.addEventListener("exo-wallet-send-tokens-pending",this.pendingTransaction),document.addEventListener("exo-wallet-send-tokens-error",this.errorTransaction)},methods:{init(){this.quantity=1,this.warning=null,this.errors=[],this.loading=!1,this.walletPassword="",this.walletPasswordShow=!1},isPositiveNumber(e){return this.product&&e&&!isNaN(e)&&e>0&&Number.isFinite(e)&&(this.product.allowFraction||Number.isSafeInteger(e))},incrementQuantity(){this.quantity=this.quantity&&this.quantity+1>0?this.quantity+1:1,this.quantity=Math.floor(this.quantity)},decrementQuantity(){this.quantity=this.quantity&&this.quantity-1>0?this.quantity-1:0,this.quantity=Math.floor(this.quantity)},pendingTransaction(e){if(this.loading){const t=e.detail;return c({productId:this.product.id,transactionHash:t.hash,amount:this.amount,quantity:this.quantity,receiver:this.product.receiverMarchand}).then((e=>{this.loading=!1,this.$emit("ordered",e),this.showAlert("success",this.$t("exoplatform.wallet.metamask.message.transactionSent"),t.hash),this.$emit("close")})).catch((e=>{console.error("Error saving order",e),this.loading=!1,this.errors.push(e&&e.message?e.message:String(e))}))}},errorTransaction(){this.loading=!1,this.showAlert("error",this.$t("exoplatform.wallet.metamask.error.transactionFailed"))},payProduct(e){if(e.preventDefault(),e.stopPropagation(),this.errors=[],!this.$refs.form.validate())return;this.loading=!0;let t=this.quantity;try{t=this.product.allowFraction?parseFloat(t):parseInt(t)}catch(e){}if(!t||isNaN(t)||t<=0||!Number.isFinite(t)||!this.product.allowFraction&&!Number.isSafeInteger(this.quantity))return void this.errors.push(this.$t("exoplatform.perkstore.warning.invalidQuantity"));if(this.quantity=t,!this.product.unlimited&&this.quantity>this.maxQuantity)return void this.errors.push(this.$t("exoplatform.perkstore.warning.invalidQuantityWithMax",{0:this.maxQuantity}));if(!this.product.receiverMarchand)return void this.errors.push(this.$t("exoplatform.perkstore.warning.noProductMarchand"));if(!this.product.price)return void this.errors.push(this.$t("exoplatform.perkstore.warning.noProductPrice"));if(!this.amount)return void this.errors.push(this.$t("exoplatform.perkstore.warning.noAmountToSend"));const r=`${this.product.title}: ${this.quantity} x ${this.product.price}${this.symbol?this.symbol:""}`;return this.isInternalWallet?c({productId:this.product.id,quantity:this.quantity,receiver:this.product.receiverMarchand},!0).then((()=>{document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens",{detail:{amount:this.amount,receiver:this.product.receiverMarchand,sender:{type:"user",id:eXo.env.portal.userName},password:this.walletPassword,label:r,message:r}}))})).catch((e=>{console.error("Checking order availability error",e),this.loading=!1,this.showAlert("error",this.$t("exoplatform.wallet.metamask.error.transactionFailed"))})):window.ethereum?.isMetaMask?s(this.product.receiverMarchand.id,this.product.receiverMarchand.type).then((e=>{this.$emit("opened-transaction",!0);const t={to:this.contractDetails.address,from:this.senderAddress,data:this.contractDetails.contract.methods.transfer(e.address,this.DecimalsAmount).encodeABI()};window.ethereum.request({method:"eth_sendTransaction",params:[t]}).then((e=>(this.$emit("opened-transaction",!1),c({productId:this.product.id,quantity:this.quantity,receiver:this.product.receiverMarchand},!0).then((()=>e))))).then((t=>this.transactionUtils.saveTransactionDetails({contractAddress:this.contractDetails.address,contractAmount:this.amount,contractMethodName:"transfer",from:this.senderAddress,label:r,message:r,pending:!0,hash:t,timestamp:Date.now(),to:e.address}))).then((e=>{document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-pending",{detail:e})),this.showAlert("success",this.$t("exoplatform.wallet.metamask.message.transactionSent"),e.hash),this.$emit("close")})).catch((e=>{this.$emit("opened-transaction",!1),e&&4001===e.code||(console.error("Checking order availability error",e),this.showAlert("error",this.$t("exoplatform.wallet.metamask.error.transactionFailed")))})).finally((()=>this.loading=!1))})):void 0},showAlert(e,t,r){this.$root.$emit("wallet-notification-alert",{type:e,message:t,transactionHash:r})}}},o,[],!1,null,null,null).exports;var h=function(){var e=this,t=e._self._c;return t("v-flex",{staticClass:"searchNoResults justify-center d-flex border-box-sizing emptyChallenges"},[t("div",{staticClass:"d-flex flex-column"},[t("v-icon",{attrs:{size:"120",color:"primary"}},[e._v("\n      "+e._s(e.icon)+"\n    ")]),e._v(" "),t("div",{staticClass:"d-flex flex-column text-center text-sub-title"},[e.info?t("span",{staticClass:"text-header-title text-light-color py-5"},[e._v(e._s(e.info))]):e._e(),e._v(" "),e.infoMessage?t("span",{staticClass:"text-sub-title subtitle-1 text-light-color pb-2",domProps:{innerHTML:e._s(e.emptyPerkstoreSummaryText)}}):e._e()])],1)])};h._withStripped=!0;const m=i({data:()=>({emptyProductsActionName:"perk-store-products-no-results"}),props:{icon:{type:String,default:""},info:{type:String,default:""},infoMessage:{type:String,default:"search.connector.label.products"},injectedLabelParam:{type:String,default:""},clickCondition:{type:Boolean,default:!1}},created(){document.addEventListener(this.emptyProductsActionName,this.noResultEvent)},beforeDestroy(){document.removeEventListener(this.emptyProductsActionName,this.noResultEvent)},computed:{emptyPerkstoreSummaryText(){const e=this.clickCondition&&this.infoMessage;return this.injectedLabelParam?.length?this.$t(e,{0:this.injectedLabelParam,1:`<a class="primary--text font-weight-bold" href="javascript:void(0)" onclick="document.dispatchEvent(new CustomEvent('${this.emptyProductsActionName}'))">`,2:"</a>"}):this.$t(e,{0:`<a class="primary--text font-weight-bold" href="javascript:void(0)" onclick="document.dispatchEvent(new CustomEvent('${this.emptyProductsActionName}'))">`,1:"</a>"})}},methods:{noResultEvent(){this.$emit("no-result-event")}}},h,[],!1,null,null,null).exports;var f=function(){var e=this,t=e._self._c;return t("exo-drawer",{ref:"BuyModalDrawer",attrs:{right:""},on:{closed:e.onCloseDrawer}},[t("template",{slot:"title"},[t("div",{staticClass:"titleBuyProductDrawer"},[e._v(e._s(e.product&&e.product.title))])]),e._v(" "),t("template",{slot:"content"},[t("perk-store-buy-form",{ref:"buyForm",attrs:{product:e.product,symbol:e.symbol,"need-password":e.needPassword,"wallet-loading":e.walletLoading,"wallet-enabled":e.walletEnabled},on:{loading:function(t){e.loading=t},"opened-transaction":e.openTransaction,ordered:function(t){return e.$emit("ordered",t)},close:e.close}})],1),e._v(" "),t("template",{slot:"footer"},[e.displayMetamaskWarnings?t("div",[t("wallet-metamask-warnings",{attrs:{"not-installed":!e.metamaskInstalled,"not-connected":!e.metamaskConnected,"invalid-network":e.invalidMetamaskNetwork,"invalid-account":e.invalidMetamaskAccount}})],1):t("div",{staticClass:"d-flex mr-2"},[t("v-spacer"),e._v(" "),t("button",{staticClass:"ignore-vuetify-classes btn me-1",attrs:{disabled:e.openedTransaction,loading:e.loading},on:{click:e.close}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.cancel"))+"\n      ")]),e._v(" "),t("v-tooltip",{attrs:{top:""},scopedSlots:e._u([{key:"activator",fn:function({on:r,attrs:s}){return[t("div",e._g(e._b({},"div",s,!1),r),[t("v-btn",{staticClass:"btn btn-primary me-1",attrs:{disabled:e.disabledButton,loading:e.loading,large:""},on:{click:e.buyProduct}},[e._v("\n              "+e._s(e.$t("exoplatform.perkstore.button.buy"))+"\n            ")])],1)]}}])},[e._v(" "),t("span",[e._v(e._s(e.buyButtonTitle))])])],1)])],2)};f._withStripped=!0;const v=i({props:{product:{type:Object,default:function(){return{}}},symbol:{type:String,default:function(){return null}},needPassword:{type:Boolean,default:function(){return!1}},walletEnabled:{type:Boolean,default:function(){return!1}},walletLoading:{type:Boolean,default:function(){return!1}}},data:()=>({dialog:!1,loading:!1,isSameNetworkVersion:!0,isSameAddress:!0,openedTransaction:!1,metamaskAddress:null,metamaskNetworkId:null,metamaskConnected:!1}),computed:{walletAddress:()=>window.walletSettings?.wallet?.address||!1,invalidMetamaskAccount(){return!this.metamaskAddress||(this.metamaskAddress||"").toLowerCase()!==(this.walletAddress||"").toLowerCase()},invalidMetamaskNetwork(){return this.metamaskNetworkId!==window.walletSettings?.network?.id},displayMetamaskWarnings(){return this.isMetamaskWallet&&(this.invalidMetamaskNetwork||this.invalidMetamaskAccount||!this.metamaskConnected)},isMetamaskWallet:()=>"METAMASK"===window.walletSettings.wallet?.provider,canBuyProduct(){return this.product?.receiverMarchand?.id&&this.product?.userData?.username!==this.product.receiverMarchand.id},buyButtonTitle(){return!this.walletEnabled||this.walletDeleted?this.$t("exoplatform.perkstore.label.disabledOrDeletedWallet"):this.product?.receiverMarchand?.id===this.product?.userData?.username?this.$t("exoplatform.perkstore.button.disabledBuyButton"):this.product.enabled?this.product.unlimited||this.available?this.$t("exoplatform.perkstore.button.buy"):this.$t("exoplatform.perkstore.label.SoldOut"):this.$t("exoplatform.perkstore.label.disabledProduct")},disabledButton(){return this.disableButton&&(!this.isSameNetworkVersion||!this.isSameAddress)||this.openedTransaction||!this.canBuyProduct}},created(){document.addEventListener("wallet-metamask-accountsChanged",this.updateSelectedMetamaskAddress),document.addEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskNetworkId),document.addEventListener("wallet-metamask-connected",this.updateSelectedMetamaskInformation),document.addEventListener("wallet-metamask-disconnected",this.updateSelectedMetamaskInformation)},beforeDestroy(){document.removeEventListener("wallet-metamask-accountsChanged",this.updateSelectedMetamaskAddress),document.removeEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskNetworkId),document.removeEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskInformation),document.removeEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskInformation)},methods:{updateSelectedMetamaskNetworkId(){this.metamaskNetworkId=window.walletSettings.metamask?.networkId},updateSelectedMetamaskAddress(){this.metamaskAddress=window.walletSettings.metamask?.address},updateSelectedMetamaskInformation(){this.metamaskInstalled=window.walletSettings.metamask?.installed,this.metamaskConnected=window.walletSettings.metamask?.connected,this.updateSelectedMetamaskNetworkId(),this.updateSelectedMetamaskAddress()},disableButton(){return this.$refs.buyForm&&this.$refs.buyForm.disablePayButton},buyProduct(e){this.$refs.buyForm.payProduct(e)},async open(){this.isMetamaskWallet&&this.updateSelectedMetamaskInformation(),await this.$refs.BuyModalDrawer.open(),this.$refs.buyForm.init()},onCloseDrawer(){this.$emit("closeProductDetails")},close(){this.$emit("closeProductDetails"),this.$refs.BuyModalDrawer.close()},openTransaction(e){this.openedTransaction=e}}},f,[],!1,null,null,null).exports;var g=function(){var e=this,t=e._self._c;return t("v-card",{attrs:{flat:""}},[[e.canAddProduct||e.products&&e.products.length?t("v-container",{staticClass:"border-box-sizing productsListParentContainer",attrs:{fluid:"","grid-list-md":""}},[t("v-layout",{staticClass:"productsListParent",attrs:{row:"",wrap:""}},[e.products&&e.products.length?[e._l(e.products,(function(r){return[t("perk-store-product-detail",{key:r.id,staticClass:"border-box-sizing",attrs:{product:r,symbol:e.symbol,"wallet-loading":e.walletLoading,"wallet-enabled":e.walletEnabled,"wallet-deleted":e.walletDeleted},on:{"product-details":function(t){return e.$emit("product-details",t)},"orders-list":e.displayOrdersList,edit:function(t){return e.$emit("edit",t)},buy:function(t){return e.$emit("buy",t)},"product-deleted":function(t){return e.$emit("product-deleted",t)}}})]}))]:e._e()],2)],1):e.loading?e._e():t("v-container",{staticClass:"text-center"},[t("div",{staticClass:"alert alert-info",staticStyle:{display:"inline-block"}},[t("i",{staticClass:"uiIconInfo"}),e._v("\n        "+e._s(e.$t("exoplatform.perkstore.info.noAvailableProduct"))+"\n      ")])])]],2)};g._withStripped=!0;const y=i({props:{products:{type:Array,default:function(){return[]}},symbol:{type:String,default:function(){return""}},loading:{type:Boolean,default:function(){return!1}},needPassword:{type:Boolean,default:function(){return!1}},walletLoading:{type:Boolean,default:function(){return!1}},walletEnabled:{type:Boolean,default:function(){return!1}},walletDeleted:{type:Boolean,default:function(){return!1}},canAddProduct:{type:Boolean,default:function(){return!1}}},methods:{displayOrdersList(e,t){this.$emit("orders-list",e,t)}}},g,[],!1,null,null,null).exports;var b=function(){var e=this,t=e._self._c;return t("div",{staticClass:"perkStoreDetailContent"},[t("v-card",{staticClass:"productDetailContentCard",attrs:{"max-width":e.overviewDisplay?"100":e.cardHeight,"max-height":e.overviewDisplay?"100":"",elevation:"0",outlined:""}},[t("v-carousel",{staticClass:"carousselParent",attrs:{"show-arrows":!1,interval:3e3,continuous:!e.showMenu,height:e.overviewDisplay?"40":e.carousselHeight,width:e.overviewDisplay?"70":"","hide-delimiters":"",cycle:""}},[e.product.imageFiles?e._l(e.product.imageFiles,(function(r,s){return t("v-carousel-item",{key:s,staticClass:"carousselImage",attrs:{src:r.src,max:"300"}},[e.overviewDisplay?e._e():t("v-toolbar",{staticClass:"toolbarCard",attrs:{color:"transparent",flat:""}},[t("v-spacer"),e._v(" "),e.isProductOwner?t("v-menu",{attrs:{"offset-x":"","offset-y":"",left:e.rtlDisplay,attach:""},scopedSlots:e._u([{key:"activator",fn:function({on:r}){return[t("v-btn",e._g({staticClass:"productCardAction mr-0",attrs:{dark:"",icon:""},on:{blur:e.closeMenu}},r),[t("v-icon",[e._v("mdi-dots-vertical")])],1)]}}],null,!0),model:{value:e.showMenu,callback:function(t){e.showMenu=t},expression:"showMenu"}},[e._v(" "),t("v-list",{staticClass:"pa-0 ma-0"},[e.userData.canEdit?t("v-list-item",{staticClass:"editLabelProduct",on:{mousedown:function(e){return e.preventDefault()}}},[t("v-list-item-title",{staticClass:"editProductMenu ml-n2",on:{click:function(t){return e.$emit("edit",e.product)}}},[t("i",{staticClass:"uiIconEdit",class:e.iconClass}),e._v(e._s(e.$t("exoplatform.perkstore.button.menuEditProduct"))+"\n                  ")])],1):e._e(),e._v(" "),t("v-list-item",{staticClass:"editLabelProduct",on:{mousedown:function(e){return e.preventDefault()}}},[t("v-list-item-title",{staticClass:"editProductMenu ml-n2",on:{click:function(t){return e.$emit("orders-list",e.product,null)}}},[t("i",{staticClass:"fas fa-list primary--text",class:e.iconClass}),e._v(e._s(e.$t("exoplatform.perkstore.button.menuProductOrders"))+"\n                  ")])],1),e._v(" "),t("v-list-item",{staticClass:"editLabelProduct",on:{mousedown:function(e){return e.preventDefault()}}},[t("v-list-item-title",{staticClass:"editProductMenu ml-n2",on:{click:function(t){return e.confirmDelete()}}},[t("i",{staticClass:"uiIconTrash primary--text",class:e.iconClass}),e._v(e._s(e.$t("exoplatform.perkstore.button.menuProductDelete"))+"\n                  ")])],1)],1)],1):e._e()],1)],1)})):e._e()],2),e._v(" "),e.hideButtons?e._e():t("v-card-text",e._g({staticClass:"pendingCard pb-0",class:e.cardTextClass||e.overviewDisplay?"pt-0":"pt-2"},e.cantBuyProduct||e.userData.notProcessedOrders?{}:{click:e.displayBuyModal}),[e.hidePending||e.overviewDisplay?e._e():t("div",{staticClass:"productCardPending py-0"},[e.userData.notProcessedOrders?t("v-hover",{scopedSlots:e._u([{key:"default",fn:function({hover:r}){return t("v-chip",{class:`${r&&"elevation-3"} userPendingOrders clickable`,on:{click:function(t){return e.$emit("orders-list",e.product,null)}}},[t("v-icon",{staticClass:"userPendingOrdersIcon",attrs:{left:!e.$vuetify.rtl,size:"16"}},[e._v("\n              far fa-clock\n            ")]),e._v("\n            "+e._s(e.userData.notProcessedOrders)+" "+e._s(e.$t("exoplatform.perkstore.label.pending"))+"\n          ")],1)}}],null,!1,4287478648)}):e._e()],1),e._v(" "),t("v-btn",{staticClass:"white--text buyButton pa-0",class:e.buyButtonClass,attrs:{disabled:e.disabledBuy||!e.walletEnabled||e.walletLoading||e.walletDeleted||!e.displayBuyButton,loading:!e.disabledBuy&&e.walletLoading,title:e.buyButtonTitle,right:!e.$vuetify.rtl,"max-height":e.overviewDisplay?"20px":"","max-width":e.overviewDisplay?"20px":"",absolute:"",fab:"",top:"",icon:""},on:{click:e.displayBuyModal}},[t("v-icon",{class:e.overviewDisplay&&"icon-mini-size"},[e._v("fa-shopping-cart")])],1)],1),e._v(" "),t("div",e._g({class:e.displayPendingChipClass},e.cantBuyProduct?{}:{click:e.displayBuyModal}),[t("v-card-text",{staticClass:"productCardTitleParent text-truncate",class:e.overviewDisplay?"pa-1 mb-1 caption":"pb-0",attrs:{title:e.product.unlimited?e.$t("exoplatform.perkstore.label.unlimitedSupply"):e.$t("exoplatform.perkstore.label.articlesSold",{0:e.purchasedPercentageLabel})}},[t("span",{attrs:{title:e.product.title}},[e._v(e._s(e.product.title))])]),e._v(" "),e.overviewDisplay?e._e():t("v-card-text",{staticClass:"productCardSubtitle"},[t("span",{staticClass:"priceSymbol"},[e._v(e._s(e.symbol))]),e._v(" "+e._s(e.product.price)+"\n      ")])],1)],1),e._v(" "),t("exo-confirm-dialog",{ref:"deleteProductConfirmDialog",attrs:{title:e.$t("exoplatform.perkstore.label.delete"),message:e.$t("exoplatform.perkstore.label.deleteConfirmMessage"),"ok-label":e.$t("exoplatform.perkstore.label.ok"),"cancel-label":e.$t("exoplatform.perkstore.label.cancel")},on:{ok:e.removeProduct}})],1)};b._withStripped=!0;const w=i({props:{product:{type:Object,default:function(){return{}}},symbol:{type:String,default:function(){return""}},walletLoading:{type:Boolean,default:function(){return!1}},walletEnabled:{type:Boolean,default:function(){return!1}},walletDeleted:{type:Boolean,default:function(){return!1}},hideButtons:{type:Boolean,default:function(){return!1}},hidePending:{type:Boolean,default:function(){return!1}},hideElevation:{type:Boolean,default:function(){return!1}},cardHeight:{type:Number,default:function(){return 600}},carousselHeight:{type:Number,default:function(){return 500}},overviewDisplay:{type:Boolean,default:function(){return!1}}},data:()=>({showMenu:!1}),computed:{isProductOwner(){return this.product.userData.canEdit||this.product.userData.username===this.product.creator.id||this.product.userData.username===this.product.receiverMarchand.id},cardTextClass(){return this.cantBuyProduct?"":"clickable "},displayPendingChipClass(){return`${this.overviewDisplay?"":"pt-4"} ${this.cardTextClass}`},cantBuyProduct(){return this.disabledBuy||!this.walletEnabled||this.walletLoading||this.walletDeleted||!this.displayBuyButton},buyButtonClass(){return`${this.cantBuyProduct?"disabledBuyButton":"btn btn-primary"} ${this.overviewDisplay?"mt-14 me-n2":""}`},buyButtonTitle(){return!this.walletEnabled||this.walletDeleted?this.$t("exoplatform.perkstore.label.disabledOrDeletedWallet"):this.product.receiverMarchand.id===eXo.env.portal.userName?this.$t("exoplatform.perkstore.button.disabledBuyButton"):this.product.enabled?this.maxOrdersReached?this.$t("exoplatform.perkstore.label.maxOrdersIsReached",{0:this.product.maxOrdersPerUser}):this.product.unlimited||this.available?this.$t("exoplatform.perkstore.button.buy"):this.$t("exoplatform.perkstore.label.SoldOut"):this.$t("exoplatform.perkstore.label.disabledProduct")},productCreatedDate(){return this.product&&this.product.createdDate&&this.formatDate(new Date(this.product.createdDate))||""},productLink(){return this.product&&`${eXo.env.portal.context}/${eXo.env.portal.portalName}/perkstore/catalog?productId=${this.product.id}`||"#"},userData(){return this.product&&this.product.userData||{}},ordersListBtnClass(){if(!this.product)return"";let e=0;return this.userData.canEdit&&e++,this.displayBuyButton&&e++,`left-pa${e}`},editBtnClass(){return this.displayBuyButton?"left-pa1":""},displayBuyButton(){return!this.hideButtons&&this.product&&this.product.enabled&&this.userData.canOrder&&this.product.receiverMarchand&&this.product.receiverMarchand.type&&this.product.receiverMarchand.id&&("user"!==this.product.receiverMarchand.type||this.product.receiverMarchand.id!==eXo.env.portal.userName)&&this.product.creator&&this.product.creator.type&&this.product.creator.id},disabledBuy(){return!this.product.unlimited&&this.available<=0||this.maxOrdersReached},purchasedPercentageLabel(){return`${Number(this.purchasedPercentage).toFixed(0)}%`},purchasedPercentage(){return this.product.unlimited?0:this.product.totalSupply?100*this.product.purchased/this.product.totalSupply:100},maxOrdersCurrentPeriodReached(){return this.userData&&this.product.orderPeriodicity&&this.userData.purchasedInCurrentPeriod&&this.userData.purchasedInCurrentPeriod>=this.product.maxOrdersPerUser},maxOrdersAllTimeReached(){return this.userData&&!this.product.orderPeriodicity&&this.userData.totalPurchased&&this.userData.totalPurchased>=this.product.maxOrdersPerUser},maxOrdersReached(){return this.product.maxOrdersPerUser&&this.userData&&(this.maxOrdersCurrentPeriodReached||this.maxOrdersAllTimeReached)},available(){if(this.product.unlimited)return 1e4;{const e=this.product.totalSupply-this.product.purchased;return e>0?e:0}},iconClass(){return this.$vuetify.rtl?"ml-2":"mr-2 "},rtlDisplay(){return!this.$vuetify.rtl}},methods:{closeMenu(){this.showMenu=!1},openProductDetail(e){e.stopPropagation(),e.preventDefault(),this.$emit("product-details",this.product)},displayBuyModal(){!this.disabledBuy&&this.walletEnabled&&this.$emit("buy",this.product)},formatDate:e=>e?e.toLocaleString(eXo.env.portal.language,{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"numeric"}):"",confirmDelete(){this.$refs.deleteProductConfirmDialog.open()},removeProduct(){var e;(e=this.product.id,fetch(`/portal/rest/perkstore/api/product/delete/${e}`,{method:"PUT",credentials:"include"}).then((e=>{if(!e||!e.ok)throw new Error(e.status)}))).then((()=>{this.$root.$emit("show-alert",{type:"success",message:this.$t("exoplatform.perkstore.label.deleteSuccess")}),this.$emit("product-deleted")})).catch((e=>{let t="";t="403"===e.message?this.$t("exoplatform.perkstore.label.deletePermissionDenied"):"404"===e.message?this.$t("exoplatform.perkstore.label.notFound"):this.$t("exoplatform.perkstore.label.deleteError"),this.$root.$emit("show-alert",{type:"error",message:t})}))}}},b,[],!1,null,null,null).exports;var x=function(){var e=this,t=e._self._c;return t("exo-drawer",{ref:"productFormDrawer",attrs:{"allow-expand":"",right:""},on:{closed:e.onCloseDrawer}},[t("template",{slot:"title"},[e._v("\n    "+e._s(e.product&&e.product.id?e.$t("exoplatform.perkstore.button.editProduct",{0:e.product.title}):e.$t("exoplatform.perkstore.label.addNewProduct"))+"\n  ")]),e._v(" "),t("template",{slot:"content"},[this.$refs.productFormDrawer&&this.$refs.productFormDrawer.drawer?t("v-form",{ref:"form",staticClass:"productFormParent",model:{value:e.valid,callback:function(t){e.valid=t},expression:"valid"}},[t("v-container",{staticClass:"white",attrs:{"grid-list-xl":""}},[t("v-layout",{class:this.$refs.productFormDrawer&&this.$refs.productFormDrawer.expand?"":"drawerProductExpand",attrs:{wrap:"","justify-space-between":""}},[t("v-flex",{class:this.$refs.productFormDrawer&&this.$refs.productFormDrawer.expand?"md4":"",attrs:{xs12:""}},[t("v-text-field",{attrs:{rules:e.requiredRule,maxlength:200,label:`${e.$t("exoplatform.perkstore.label.productTitle")} *`,placeholder:e.$t("exoplatform.perkstore.label.productTitlePlaceholder"),name:"ProductTitle",required:"",autofocus:"",counter:""},model:{value:e.product.title,callback:function(t){e.$set(e.product,"title",t)},expression:"product.title"}}),e._v(" "),t("v-textarea",{attrs:{maxlength:e.maxTextAreaSize,label:e.$t("exoplatform.perkstore.label.productDescription"),placeholder:e.$t("exoplatform.perkstore.label.productDescriptionPlaceholder"),name:"ProductDescription",rows:"5",flat:"",counter:""},model:{value:e.product.description,callback:function(t){e.$set(e.product,"description",t)},expression:"product.description"}}),e._v(" "),t("perk-store-auto-complete",{ref:"receiverMarchandAutocomplete",attrs:{rules:e.requiredRule,"input-label":`${e.$t("exoplatform.perkstore.label.marchandWallet")} *`,"input-placeholder":e.$t("exoplatform.perkstore.label.marchandWalletPlaceholder"),"no-data-label":e.$t("exoplatform.perkstore.label.marchandWalletSearchPlaceholder"),"big-field":"",required:""},on:{"item-selected":e.selectRecipient,"clear-selection":function(t){return e.selectRecipient()}}}),e._v(" "),t("perk-store-auto-complete",{ref:"productMarchandsAutocomplete",attrs:{rules:e.rules,"input-label":`${e.$t("exoplatform.perkstore.label.productEditors")} *`,"input-placeholder":e.$t("exoplatform.perkstore.label.productEditorsPlaceholder"),"no-data-label":e.$t("exoplatform.perkstore.label.productEditorsSearchPlaceholder"),multiple:"","only-users":"","no-address":"","big-field":"",required:""},on:{"item-selected":e.selectEditor,"clear-selection":function(t){return e.selectEditor()}}}),e._v(" "),t("perk-store-auto-complete",{ref:"productAccessPermissionAutocomplete",attrs:{"input-label":e.$t("exoplatform.perkstore.label.productAllowedBuyers"),"input-placeholder":e.$t("exoplatform.perkstore.label.productAllowedBuyersPlaceholder"),"no-data-label":e.$t("exoplatform.perkstore.label.productAllowedBuyersSearchPlaceholder"),multiple:"","no-address":"","big-field":""},on:{"item-selected":e.selectAccessPermission,"clear-selection":function(t){return e.selectAccessPermission()}}})],1),e._v(" "),t("v-flex",{class:this.$refs.productFormDrawer&&this.$refs.productFormDrawer.expand?"md6":"",attrs:{xs12:""}},[t("v-text-field",{attrs:{rules:e.requiredNumberRule,label:`${e.$t("exoplatform.perkstore.label.price")} *`,placeholder:e.$t("exoplatform.perkstore.label.pricePlaceholder"),name:"ProductPrice",required:""},model:{value:e.product.price,callback:function(t){e.$set(e.product,"price",e._n(t))},expression:"product.price"}}),e._v(" "),t("perk-store-upload-input",{attrs:{"max-files":3,"max-uploads-size-in-mb":5,files:e.product.imageFiles}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.enabledProduct")},model:{value:e.product.enabled,callback:function(t){e.$set(e.product,"enabled",t)},expression:"product.enabled"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.limitedSupply")},model:{value:e.limitedSupply,callback:function(t){e.limitedSupply=t},expression:"limitedSupply"}}),e._v(" "),e.limitedSupply?t("v-layout",{staticClass:"sub-text",attrs:{row:""}},[t("v-flex",{attrs:{xs5:""}},[t("label",[e._v(e._s(`${e.$t("exoplatform.perkstore.label.totalSupply")} *`))])]),e._v(" "),t("v-flex",{attrs:{xs7:""}},[t("v-text-field",{attrs:{name:"ProductTotalSupply",placeholder:e.$t("exoplatform.perkstore.label.totalSupplyPlaceholder"),rules:e.requiredRule,"single-line":"",required:""},model:{value:e.product.totalSupply,callback:function(t){e.$set(e.product,"totalSupply",e._n(t))},expression:"product.totalSupply"}})],1)],1):e._e(),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.limitedOders")},model:{value:e.limitedOrdersPerUser,callback:function(t){e.limitedOrdersPerUser=t},expression:"limitedOrdersPerUser"}}),e._v(" "),e.limitedOrdersPerUser?t("v-layout",{staticClass:"sub-text",attrs:{row:""}},[t("v-flex",{attrs:{xs5:""}},[t("label",[e._v(e._s(`${e.limitedOrdersPerUserLabel} *`))])]),e._v(" "),t("v-flex",{attrs:{xs7:""}},[t("v-text-field",{attrs:{rules:e.requiredIntegerRule,placeholder:e.$t("exoplatform.perkstore.label.maxOrdersPerUserPlaceholder"),name:"ProductMaxOrdersPerUser","single-line":"",required:""},model:{value:e.product.maxOrdersPerUser,callback:function(t){e.$set(e.product,"maxOrdersPerUser",e._n(t))},expression:"product.maxOrdersPerUser"}})],1),e._v(" "),t("v-flex",{attrs:{xs5:""}},[t("label",[e._v(e._s(e.$t("exoplatform.perkstore.label.userOrdersLimitationPeriodicity")))])]),e._v(" "),t("v-flex",{attrs:{xs7:""}},[e.limitedOrdersPerUser?t("v-select",{attrs:{items:e.periods,disabled:!e.product.maxOrdersPerUser||!e.limitedOrdersPerUser,placeholder:e.$t("exoplatform.perkstore.label.userOrdersLimitationPeriodicityPlaceholder"),"item-text":"text","item-value":"value","hide-no-data":"","hide-selected":"","small-chips":""},model:{value:e.product.orderPeriodicity,callback:function(t){e.$set(e.product,"orderPeriodicity",t)},expression:"product.orderPeriodicity"}}):e._e()],1)],1):e._e()],1)],1)],1)],1):e._e()],1),e._v(" "),t("template",{slot:"footer"},[t("div",{staticClass:"d-flex"},[t("v-spacer"),e._v(" "),t("button",{staticClass:"ignore-vuetify-classes btn btn-primary me-1",attrs:{disabled:e.enableSaveProduct},on:{click:e.saveProduct}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.save"))+"\n      ")]),e._v(" "),t("button",{staticClass:"ignore-vuetify-classes btn",on:{click:e.close}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.cancel"))+"\n      ")])],1)])],2)};x._withStripped=!0;const k=i({props:{product:{type:Object,default:function(){return{}}}},data(){return{valid:!0,productEditionId:null,limitedOrdersPerUser:!1,limitedSupply:!1,rules:[e=>!(!e||!e.length)||this.$t("exoplatform.perkstore.warning.requiredField")],requiredRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField")],requiredIntegerRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField"),e=>!e||this.isPositiveNumber(e,!0)||this.$t("exoplatform.perkstore.warning.invalidPositiveNumber")],requiredNumberRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField"),e=>this.isPositiveNumber(e)||this.$t("exoplatform.perkstore.warning.invalidPositiveNumber"),e=>this.isValidDecimals(e)||this.$t("exoplatform.perkstore.warning.invalidNumberOfDecimals",{0:3})],maxTextAreaSize:2e3}},computed:{enableSaveProduct(){return!this.valid||this.product?.imageFiles&&0===this.product?.imageFiles.length},orderPeriodicity(){return this.product&&"none"!==this.product.orderPeriodicity&&this.product.orderPeriodicity||""},orderPeriodicitySuffix(){return this.orderPeriodicity&&`Per${this.capitalize(this.orderPeriodicity)}`||""},limitedOrdersPerUserLabel(){return this.$t(`exoplatform.perkstore.label.maxOrdersPerUser${this.orderPeriodicitySuffix}`)},periods(){return[{text:this.$t("exoplatform.perkstore.label.noPeriodicity"),value:"none"},{text:this.$t("exoplatform.perkstore.label.week"),value:"Week"},{text:this.$t("exoplatform.perkstore.label.month"),value:"Month"},{text:this.$t("exoplatform.perkstore.label.quarter"),value:"Quarter"},{text:this.$t("exoplatform.perkstore.label.semester"),value:"Semester"},{text:this.$t("exoplatform.perkstore.label.year"),value:"Year"}]}},watch:{limitedSupply(){this.product.unlimited=!this.limitedSupply},limitedOrdersPerUser(){this.product.orderPeriodicity=this.product.orderPeriodicity||"none"}},methods:{onCloseDrawer(){0!==Object.keys(this.product).length&&this.$emit("closeDrawer")},close(){this.$refs.productFormDrawer.close()},async open(){await this.$refs.productFormDrawer.open(),this.init()},init(){this.product=this.product||{},this.product.receiverMarchand&&this.$refs.receiverMarchandAutocomplete.selectItems(this.product.receiverMarchand),this.product.marchands||this.product.creator||(this.product.marchands=[{type:"user",id:eXo.env.portal.userName,disabled:!0}]),this.product.marchands&&this.$refs.productMarchandsAutocomplete.selectItems(this.product.marchands),!this.product.receiverMarchand&&this.product.marchands&&this.$refs.receiverMarchandAutocomplete.selectItems(this.product.marchands),this.product.accessPermissions&&this.$refs.productAccessPermissionAutocomplete.selectItems(this.product.accessPermissions),this.productEditionId=`FileMultiUploadComponent${parseInt(Math.random()*this.MAX_RANDOM_NUMBER)}`,this.limitedOrdersPerUser=this.product&&this.product.maxOrdersPerUser&&this.product.maxOrdersPerUser>0,this.product.orderPeriodicity=this.product&&this.product.orderPeriodicity||"none",this.limitedSupply=this.product&&this.product.id&&!this.product.unlimited,this.product.enabled=!this.product.id||this.product.enabled},selectRecipient(e){this.product.receiverMarchand=e},selectEditor(e){this.product.marchands||(this.product.marchands=[]),e?this.product.marchands.push(e):this.product.marchands.length&&(this.product.marchands=[])},selectAccessPermission(e){this.product.accessPermissions||(this.product.accessPermissions=[]),e?this.product.accessPermissions.push(e):this.product.accessPermissions.length&&(this.product.accessPermissions=[])},isPositiveNumber:(e,t)=>e&&!isNaN(e)&&e>0&&Number.isFinite(e)&&(!t||Number.isSafeInteger(e)),capitalize:e=>e?e.charAt(0).toUpperCase()+e.slice(1).toLowerCase():"",isValidDecimals:e=>!(String(e).indexOf(".")>=0)||String(e).split(".")[1].length<=3,saveProduct(e){return e.preventDefault(),e.stopPropagation(),!!this.$refs.form.validate()&&(this.$emit("error",null),this.product&&this.product.imageFiles&&this.product.imageFiles.forEach((e=>{delete e.src,delete e.data,delete e.file,delete e.progress,delete e.finished})),this.product.unlimited=!this.limitedSupply,this.product.unlimited&&(this.product.totalSupply=0),this.limitedOrdersPerUser||(this.product.maxOrdersPerUser=0,this.product.orderPeriodicity="none"),(t=this.product,fetch("/portal/rest/perkstore/api/product",{method:"POST",credentials:"include",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(t)}).then((e=>e&&e.ok?e.json():l(e,"Error saving product")))).then((()=>{this.$emit("refreshProduct"),this.close(),this.product={}})).catch((e=>{console.error("Error saving product",e),this.$emit("error",e&&e.message?e.message:String(e)),this.close()})));var t}}},x,[],!1,null,null,null).exports;var _=function(){var e=this,t=e._self._c;return t("div",{staticClass:"border-box-sizing clickable"},[t("button",{staticClass:"btn ignore-vuetify-classes me-1",on:{click:function(t){return e.$emit("create-product")}}},[t("i",{staticClass:"orderDetailUiIcons fas fa-plus pr-1"}),e._v(" "),t("span",{staticClass:"ms-2 d-none d-lg-inline"},[e._v("\n      "+e._s(e.$t("exoplatform.perkstore.button.addProduct"))+"\n    ")])]),e._v(" "),t("span",{staticClass:"textBalance"},[e._v("\n    "+e._s(e.$t("exoplatform.perkstore.label.balance"))+" :\n    "),t("span",{staticClass:"symbol"},[e._v(" "+e._s(e.symbol)+" ")]),e._v(" "),t("span",{staticClass:"balance"},[e._v(e._s(e.balance)+"  ")])])])};_._withStripped=!0;const C=i({props:{symbol:{type:Object,default:function(){return null}},balance:{type:Object,default:function(){return null}}}},_,[],!1,null,null,null).exports;var P=function(){var e=this,t=e._self._c;return t("v-dialog",{staticClass:"DeliveredProductModal",attrs:{"content-class":"uiPopup with-overflow",width:"300px","max-width":"100vw",eager:""},model:{value:e.dialog,callback:function(t){e.dialog=t},expression:"dialog"}},[t("v-card",{staticClass:"elevation-12"},[t("div",{staticClass:"ignore-vuetify-classes popupHeader ClearFix"},[t("a",{staticClass:"uiIconClose pull-right",attrs:{"aria-hidden":"true"},on:{click:function(t){e.dialog=!1}}}),e._v(" "),t("span",{staticClass:"ignore-vuetify-classes PopupTitle popupTitle text-truncate"},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.title.deliverOrderModal",{0:e.order&&e.order.id}))+"\n      ")])]),e._v(" "),t("v-list",{staticClass:"pt-0 pb-0 px-3",attrs:{flat:""}},[e.error&&!e.loading?t("v-list-item",{staticClass:"mb-3 mt-2",attrs:{dense:""}},[t("v-list-item-content",[t("div",{staticClass:"alert alert-error v-content"},[t("i",{staticClass:"uiIconError"}),e._v("\n            "+e._s(e.error)+"\n          ")])])],1):e._e(),e._v(" "),t("div",{staticClass:"d-flex align-center pb-3"},[t("span",{staticClass:"pe-2"},[e._v(e._s(e.$t("exoplatform.perkstore.label.buyer"))+":")]),e._v(" "),e.order.sender?t("exo-user-avatar",{attrs:{"profile-id":e.order.sender.id,size:28,popover:""}}):e._e()],1),e._v(" "),e.order&&e.order.remainingQuantityToProcess?[t("label",{staticClass:"align-center"},[e._v("\n          "+e._s(e.$t("exoplatform.perkstore.label.quantityWithMax",{0:e.order.remainingQuantityToProcess}))+"\n        ")]),e._v(" "),t("v-list-item",{attrs:{dense:""}},[t("v-list-item-content",{staticClass:"align-center"},[t("v-text-field",{staticClass:"text-center orderDeliverQuantity",attrs:{disabled:e.loading,rules:e.requiredNumberRule,"append-icon":"fa-plus","prepend-inner-icon":"fa-minus",name:"quantity",required:""},on:{"click:prepend-inner":e.decrementQuantity,"click:append":e.incrementQuantity},model:{value:e.quantity,callback:function(t){e.quantity=e._n(t)},expression:"quantity"}})],1)],1)]:e._e()],2),e._v(" "),t("v-card-actions",[t("v-spacer"),e._v(" "),e.order&&e.order.remainingQuantityToProcess?t("button",{staticClass:"ignore-vuetify-classes btn btn-primary me-1",attrs:{disabled:e.disableDeliverButton},on:{click:e.deliverProduct}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.save"))+"\n      ")]):e._e(),e._v(" "),t("button",{staticClass:"ignore-vuetify-classes btn",attrs:{disabled:e.loading},on:{click:function(t){e.dialog=!1}}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.close"))+"\n      ")]),e._v(" "),t("v-spacer")],1)],1)],1)};P._withStripped=!0;const D=i({props:{product:{type:Object,default:function(){return{}}},order:{type:Object,default:function(){return{}}},visibleButton:{type:Boolean,default:function(){return!1}}},data(){return{dialog:!1,loading:!1,quantity:null,error:null,requiredNumberRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField"),e=>!e||this.isPositiveNumber(e)||this.$t("exoplatform.perkstore.warning.invalidPositiveNumber"),e=>!e||this.quantity<=this.order.remainingQuantityToProcess||this.$t("exoplatform.perkstore.warning.maxQuantityReached",{0:this.remainingQuantityToProcess})]}},computed:{totalDeliveredQuantity(){return Number(this.quantity)+Number(this.order.deliveredQuantity)},disableDeliverButton(){return this.loading||!this.order||!this.isPositiveNumber(this.quantity)||this.quantity>this.order.remainingQuantityToProcess}},watch:{error(){this.error&&(this.loading=!1)},order(){this.validateOrder()},quantity(){this.validateOrder()},dialog(){this.dialog?(this.quantity=1,this.warning=null,this.error=null,this.loading=!1):this.$emit("closed")}},methods:{openNoSelection(){this.dialog=!0},open(e,t,r){e&&t&&r&&(this.dialog=!0,this.$nextTick((()=>this.validateOrder(e,t,r))))},close(){this.dialog=!1},incrementQuantity(){this.quantity=this.quantity&&this.quantity+1>0?this.quantity+1:1,this.quantity=Math.floor(this.quantity)},decrementQuantity(){this.quantity=this.quantity&&this.quantity-1>0?this.quantity-1:0,this.quantity=Math.floor(this.quantity)},isPositiveNumber:e=>e&&!isNaN(e)&&e>0&&Number.isFinite(e),validateOrder(e,t,r){this.error=null,this.order?this.order.remainingQuantityToProcess?t&&this.order.id&&String(t)!==String(this.order.id)||e&&this.order.productId&&String(e)!==String(this.order.productId)?this.error=this.$t("exoplatform.perkstore.warning.invalidProductOrder"):!r||this.order.sender&&r===this.order.sender.id?this.isPositiveNumber(this.quantity)&&(this.product.allowFraction||Number.isSafeInteger(this.quantity))?this.quantity>this.order.remainingQuantityToProcess?this.error=this.$t("exoplatform.perkstore.warning.invalidDeliverQuantity",{0:this.order.remainingQuantityToProcess}):this.order.sender||(this.error=this.$t("exoplatform.perkstore.warning.noOrderBuyer")):this.error=this.$t("exoplatform.perkstore.warning.invalidQuantity"):this.error=this.$t("exoplatform.perkstore.warning.invalidOrderBuyer"):this.error=this.$t("exoplatform.perkstore.warning.orderIsCompletelyDelivered"):this.error=this.$t("exoplatform.perkstore.warning.noSelectedOrder")},deliverProduct(){if(this.validateOrder(),!this.error)return this.loading=!0,u({id:this.order.id,productId:this.order.productId,deliveredQuantity:Number(this.totalDeliveredQuantity)},"DELIVERED_QUANTITY").then((e=>{this.dialog=!1,this.loading=!1,this.$emit("delivered",e)})).catch((e=>{console.error("Error saving delivered quantity",e),this.loading=!1,this.error=e&&e.message?e.message:String(e)}))}}},P,[],!1,null,null,null).exports;var S=function(){var e=this,t=e._self._c;return t("div",{staticClass:"fileDrop mt-4"},[t("label",{directives:[{name:"show",rawName:"v-show",value:e.files&&e.files.length<e.maxFiles,expression:"files && files.length < maxFiles"}],staticClass:"dropZone clickable",attrs:{for:"perk-store-attach-file"}},[t("span",{staticClass:"dropMsg"},[t("i",{staticClass:"uiIcon attachFileIcon"}),e._v(" "+e._s(e.$t("exoplatform.perkstore.label.dropFilesAreaLabel"))+"\n    ")]),e._v(" "),t("input",{ref:"perkStoreAttachFile",staticClass:"attachFile hidden",attrs:{id:"perk-store-attach-file",dropzone:"",type:"file",accept:".gif,.jpg,.jpeg,.png",multiple:""}}),e._v("*\n  ")]),e._v(" "),t("div",{staticClass:"uploadContainer"},[e.error?t("div",{staticClass:"alert alert-error v-content"},[t("i",{staticClass:"uiIconError"}),e._v(e._s(e.error)+"\n    ")]):e._e(),e._v(" "),t("v-list",{staticClass:"pt-0",attrs:{"two-line":"",dense:""}},[e._l(e.files,(function(r){return[t("v-list-item",{key:r.uploadId||r.id,attrs:{ripple:""}},[t("v-list-item-avatar",[t("img",{attrs:{src:r.src}})]),e._v(" "),t("v-list-item-content",[t("v-list-item-title",{attrs:{title:r.name}},[e._v(e._s(r.name))]),e._v(" "),r.file&&(r.progress<100||!r.finished)?t("v-list-item-subtitle",[t("v-progress-linear",{attrs:{indeterminate:!r.finished&&r.progress<=1,query:""},model:{value:r.progress,callback:function(t){e.$set(r,"progress",t)},expression:"fileDetail.progress"}})],1):t("v-list-item-subtitle",[e._v(e._s(e.getFileSize(r.size)))])],1),e._v(" "),t("v-list-item-action",[t("v-list-item-action-text",{staticClass:"pb-3"},[100===r.progress?t("v-btn",{attrs:{title:e.$t("exoplatform.perkstore.button.delete"),icon:"",ripple:""},on:{click:function(t){return e.deleteFile(r.file||r.id)}}},[t("i",{staticClass:"uiIconTrash uiIconBlue"})]):t("v-btn",{attrs:{title:e.$t("exoplatform.perkstore.button.cancel"),icon:"",ripple:""},on:{click:function(t){return e.abortUpload(r.file||r.id)}}},[t("i",{staticClass:"uiIconTrash uiIconBlue"})])],1)],1)],1),e._v(" "),t("v-divider",{key:r.uploadId||r.id})]}))],2)],1)])};S._withStripped=!0;const I=i({props:{maxFiles:{type:Number,default:function(){return 0}},maxUploadsSizeInMb:{type:Number,default:function(){return 0}},files:{type:Array,default:()=>null}},data:()=>({error:""}),watch:{error(){this.error&&setTimeout((()=>this.error=null),5e3)}},mounted(){const e=$(this.$el).find(".dropZone"),t=this;let r="";e.filedrop({fallback_id:"perk-store-attach-file",url:function(){const e=Math.round(1e5*Math.random()),t=Date.now();return r=`${e}-${t}`,`${eXo.env.portal.context}/upload?uploadId=${r}&action=upload`},paramname:"userfile",error:function(e,r){switch(t.error=null,e){case"ErrorTooManyFiles":case"TooManyFiles":t.error=t.$t("exoplatform.perkstore.error.uploadMaxFileCountReached",{0:r&&r.name||"",1:t.maxFiles});break;case"ErrorFileTooLarge":case"FileTooLarge":t.error=t.$t("exoplatform.perkstore.error.uploadMaxFileSizeExceeded",{0:r&&r.name||"",1:t.maxUploadsSizeInMb});break;case"ErrorFileTypeNotAllowed":case"FileTypeNotAllowed":t.error=t.$t("exoplatform.perkstore.error.uploadUnsupportedFileType",{0:r&&r.name||""})}r&&t.deleteFile(r),t.error||(t.error=t.$t("exoplatform.perkstore.error.uploadGenericError",{0:r&&r.name||"",1:t.maxFiles}))},allowedfiletypes:["image/jpeg","image/png","image/gif"],allowedfileextensions:[".jpg",".jpeg",".png",".gif"],maxfilesize:t.maxUploadsSizeInMb,queuefiles:1,rename:t.getFileName,beforeEach:e=>{if(t.maxFiles-t.files.length<=0)throw new Error(t.$t("exoplatform.perkstore.error.uploadMaxFileCountReached",{0:e&&e.name||"",1:t.maxFiles}))},dragOver:function(){$(".dropZone").addClass("hover")},dragLeave:function(){$(".dropZone").removeClass("hover")},uploadStarted:(e,s)=>{0===e&&(t.error=null);const i={id:null,uploadId:r,name:s.name,size:s.size,src:null,progress:0,file:s,finished:!1},a=new FileReader;a.onload=e=>{const r=e.target.result;t.$set(i,"src",r),t.$set(i,"data",r),t.$forceUpdate()},a.readAsDataURL(s),t.files.push(i)},progressUpdated:(e,r,s)=>{const i=t.files.find((e=>e.file===r));i&&(i.progress=s)},uploadFinished:(e,r)=>{t.$emit("changed");const s=t.files.find((e=>e.file===r));setTimeout((()=>{t.$set(s,"finished",!0)}),500)}})},methods:{abortUpload(e){this.deleteFile(e)},deleteFile(e){const t=this.files.findIndex((t=>t.file===e||t.id===e));if(t<0)return;const r=this.files[t];if(r.uploadId)fetch(`${eXo.env.portal.context}/upload?uploadId=${r.uploadId}&action=${r.progress&&r.progress<100?"abort":"delete"}`,{method:"post",credentials:"include"}).then((()=>{this.files.splice(t,1);const r=new DataTransfer;Object.values(this.$refs.perkStoreAttachFile.files).forEach((t=>{t!==e&&r.items.add(t)})),this.$refs.perkStoreAttachFile.files=r.files,this.$emit("changed")})).catch((e=>{this.error=e}));else{this.files.splice(t,1);const r=new DataTransfer;this.$refs.perkStoreAttachFile.files.forEach((t=>{t!==e&&r.files.push(t)})),this.$refs.perkStoreAttachFile.files=r.files,this.$emit("changed")}},getFileSize(e){return e<10485.76?(e=Number(e/1024).toFixed(2),this.$t("exoplatform.perkstore.label.sizeInKB",{0:e})):(e=Number(e/1048576).toFixed(2),this.$t("exoplatform.perkstore.label.sizeInMB",{0:e}))},getFileName(e){for(;this.files.find((t=>t.name===e));)e=`${e}_`;return e}}},S,[],!1,null,null,null).exports;var O=function(){var e=this,t=e._self._c;return e.hasImages?t("v-layout",{staticClass:"no-wrap"},[e.displaySelector?t("v-flex",{attrs:{xs2:""}},[t("v-layout",{staticClass:"imageMiniPreviewParent mx-0",attrs:{row:"",wrap:""}},e._l(e.images,(function(r,s){return t("v-flex",{key:r.id,staticClass:"clickable",on:{click:function(t){e.selectedImageIndex=s}}},[t("v-card",{staticClass:"imageMiniPreview"},[t("v-img",{attrs:{src:r.src,"aspect-ratio":"1","max-height":"70px","max-width":"70px"}})],1)],1)})),1)],1):e._e(),e._v(" "),t("v-flex",{staticClass:"productImageContainer",class:e.imageClass},[t("v-img",{staticClass:"productImage",attrs:{src:e.selectedImage.src,"max-height":"100%","max-width":"100%",width:"100%",contain:""}})],1)],1):t("div",{staticClass:"productNoImageContainer"},[t("v-icon",{staticClass:"productNoImages"},[e._v("fa-images")])],1)};O._withStripped=!0;const A=i({props:{images:{type:Array,default:function(){return[]}}},data:()=>({selectedImageIndex:0}),computed:{hasImages(){return this.images&&this.images.length},imageClass(){return this.displaySelector?"xs10":"standaloneImage xs12"},displaySelector(){return this.images&&this.images.length>1},selectedImage(){return this.images&&this.images.length?this.images[this.selectedImageIndex]:null}}},O,[],!1,null,null,null).exports;var L=function(){var e=this,t=e._self._c;return e.order?t("v-hover",{staticClass:"orderDetailParent"},[t("v-card",[e.order.sender?t("v-card-title",{staticClass:"pt-1 pb-1 subtitle-1 orderCardTitle no-wrap"},[t("div",{staticClass:"text-truncate orderDetailText"},[e.order.sender?t("exo-user-avatar",{attrs:{"profile-id":e.order.sender.id,size:28,popover:""}}):e._e()],1),e._v(" "),t("v-spacer"),e._v(" "),e.orderCheckIn?t("i",{staticClass:"uiIconEcmsCheckIn orderDetailCheckInUiIcons"}):t("i",{staticClass:"uiIconEcmsCheckOut orderDetailCheckOutUiIcons"})],1):e._e(),e._v(" "),t("v-divider"),e._v(" "),t("v-list",{attrs:{dense:""}},[t("v-list-item",{staticClass:"mb-1 pl-4 pb-3 pr-2 pt-1 orderCardSubtitle"},[t("v-list-item-content",{staticClass:"align-start"},[t("h4",[t("a",{attrs:{href:e.orderLink,rel:"nofollow",target:"_blank"}},[t("strong",[e._v("#"+e._s(e.order.id))])])])]),e._v(" "),t("v-list-item-content",{staticClass:"align-end"},[e.orderCheckIn?t("span",[e._v(e._s(e.$t(`exoplatform.perkstore.label.status.${e.order.status.toLowerCase()}`)))]):[t("select",{directives:[{name:"model",rawName:"v-model",value:e.order.status,expression:"order.status"}],staticClass:"small my-auto me-2 ignore-vuetify-classes",on:{change:[function(t){var r=Array.prototype.filter.call(t.target.options,(function(e){return e.selected})).map((function(e){return"_value"in e?e._value:e.value}));e.$set(e.order,"status",t.target.multiple?r:r[0])},function(t){return e.changeStatus()}]}},e._l(e.statusListItems,(function(r){return t("option",{key:r,attrs:{disabled:r.disabled},domProps:{value:r.name}},[e._v("\n                "+e._s(e.$t(`exoplatform.perkstore.label.status.${r.name.toLowerCase()}`))+"\n              ")])})),0)]],2)],1),e._v(" "),t("v-divider"),e._v(" "),t("v-list-item",[t("i",{staticClass:"uiIconDatePicker orderDetailUiIcons"}),e._v(" "),t("div",{staticClass:"text-truncate",attrs:{title:e.createdDateLabel}},[e._v("\n          "+e._s(e.createdDateLabel)+"\n        ")])]),e._v(" "),t("v-list-item",[t("i",{staticClass:"uiIconTag orderDetailUiIcons"}),e._v(" "),t("div",{staticClass:"text-truncate"},[e._v("\n          "+e._s(e.order.quantity)+" x\n          "),t("a",{attrs:{href:e.productLink,title:e.productTitle},on:{click:e.openProductDetail}},[e._v("\n            "+e._s(e.productTitle)+"\n          ")])])]),e._v(" "),t("v-list-item",[t("div",{staticClass:"no-wrap d-flex overflow-hidden"},[t("i",{staticClass:"uiIconCard orderDetailUiIcons"}),e._v(" "),e.transactionLink?t("a",{attrs:{href:e.transactionLink,title:e.$t("exoplatform.perkstore.label.openInWallet"),rel:"nofollow",target:"_blank"}},[e._v("\n            "+e._s(e.symbol)+" "+e._s(e.orderAmount)+"\n          ")]):[e._v("\n            "+e._s(e.symbol)+" "+e._s(e.orderAmount)+"\n          ")],e._v(" "),t("span",{staticClass:"px-1"},[e._v(e._s(e.$t("exoplatform.perkstore.label.sentTo")))]),e._v(" "),e.order.receiver&&"user"===e.order.receiver.type?t("exo-user-avatar",{attrs:{"profile-id":e.order.receiver.id,size:28,fullname:"","link-style":"",popover:""}}):e._e(),e._v(" "),e.order.receiver&&"space"===e.order.receiver.type?t("exo-space-avatar",{attrs:{"space-id":e.order.receiver.spaceId,size:28,fullname:"","link-style":"",popover:""}}):e._e()],2)])],1),e._v(" "),t("v-divider"),e._v(" "),t("v-list",{staticClass:"orderProcessingDetails",attrs:{dense:""}},[t("v-list-item",{staticClass:"orderProcessingContent orderCardSubtitle justify-center"},[t("div",[e.refunding||e.order.remainingQuantityToProcess&&!e.isError?e.userData&&e.userData.canEdit?[e.isOrdered?t("button",{staticClass:"ignore-vuetify-classes btn orderProcessingBtn text-truncate",on:{click:function(t){return e.changeStatus("CANCELED")}}},[e._v("\n              "+e._s(e.$t("exoplatform.perkstore.button.cancel"))+"\n            ")]):e._e(),e._v(" "),e.canDeliverOrder?t("button",{staticClass:"ignore-vuetify-classes btn btn-primary orderProcessingBtn text-truncate me-1 ms-1",on:{click:function(t){return e.$refs.deliverModal.openNoSelection()}}},[e._v("\n              "+e._s(e.$t("exoplatform.perkstore.button.deliver"))+"\n            ")]):e._e(),e._v(" "),e.canRefundOrder?t("button",{staticClass:"ignore-vuetify-classes btn orderProcessingBtn text-truncate text-truncate me-1 ms-1",on:{click:function(t){return e.$refs.refundDrawer.open()}}},[e._v("\n              "+e._s(e.$t("exoplatform.perkstore.button.refund"))+"\n            ")]):e._e(),e._v(" "),e.canDeliverOrder?t("perk-store-deliver-modal",{ref:"deliverModal",attrs:{product:e.orderProduct,order:e.order}}):e._e(),e._v(" "),e.canRefundOrder?t("perk-store-refund-drawer",{ref:"refundDrawer",attrs:{product:e.orderProduct,order:e.order,symbol:e.symbol},on:{refunding:function(t){e.refunding=!0},refunded:e.refunded,closed:e.refundDrawerClosed}}):e._e()]:e.isCanceled?t("div",[e._v("\n            "+e._s(e.$t("exoplatform.perkstore.label.status.canceled"))+"\n          ")]):t("div",[t("v-icon",{staticClass:"orange--text me-1",attrs:{size:"16"}},[e._v("far fa-clock")]),e._v("PENDING\n          ")],1):t("div",[t("v-icon",{staticClass:"green--text me-1",attrs:{size:"16"}},[e._v("fa-check-circle")]),e._v(e._s(e.$t("exoplatform.perkstore.label.processingDone"))+"\n          ")],1)],2)]),e._v(" "),t("v-list-item",{staticClass:"mt-1 justify-center"},[t("div",{staticClass:"no-wrap orderDeliveredLabel"},[t("v-progress-circular",{staticClass:"ms-2",attrs:{rotate:360,size:40,width:5,value:e.deliveredPercentage,color:e.deliveredPercentageColor}},[t("span",{staticClass:"no-wrap"},[e._v("\n              "+e._s(e.order.deliveredQuantity)+"/"+e._s(e.order.quantity)+"\n            ")])])],1)])],1)],1)],1):e._e()};function F(e){if(!e)return"-";const t=new Date(e);return`${t.toLocaleDateString(eXo.env.portal.language,{year:"numeric",month:"long",day:"numeric"})} - ${t.toLocaleTimeString()}`}L._withStripped=!0;const M=i({props:{product:{type:Object,default:function(){return{}}},order:{type:Object,default:function(){return{}}},symbol:{type:String,default:function(){return""}}},data(){return{refunding:!1,orderProduct:{},statusListItems:[{name:"ORDERED",disabled:"ordered"!==this.order.status.toLowerCase()},{name:"CANCELED"},{name:"ERROR"},{name:"PAID",disabled:"paid"!==this.order.status.toLowerCase()},{name:"PARTIAL"},{name:"DELIVERED",disabled:"delivered"!==this.order.status.toLowerCase()},{name:"REFUNDED"},{name:"FRAUD"}]}},computed:{orderCheckIn(){return this.order.sender.id===eXo.env.portal.userName},orderAmount(){return this.order&&this.order.amount&&n(this.order.amount)||0},transactionLink(){if(this.order.transactionHash&&this.order){if(this.order.sender&&"user"===this.order.sender.type&&this.order.sender.id===eXo.env.portal.userName||this.order.receiver&&"user"===this.order.receiver.type&&this.order.receiver.id===eXo.env.portal.userName)return`${eXo.env.portal.context}/${eXo.env.portal.portalName}/wallet?hash=${this.order.transactionHash}&principal=true`;if(this.order.receiver&&"space"===this.order.receiver.type)return`${eXo.env.portal.context}/g/:spaces:${this.order.receiver.spaceURLId}/${this.order.receiver.id}/SpaceWallet?hash=${this.order.transactionHash}&principal=true`}return null},refundTransactionLink(){if(this.order&&this.order.refundTransactionHash){if(this.order.receiver&&"user"===this.order.receiver.type&&this.order.receiver.id===eXo.env.portal.userName||this.order.sender&&"user"===this.order.sender.type&&this.order.sender.id===eXo.env.portal.userName)return`${eXo.env.portal.context}/${eXo.env.portal.portalName}/wallet?hash=${this.order.refundTransactionHash}&principal=true`;if(this.order.receiver&&"space"===this.order.receiver.type)return`${eXo.env.portal.context}/g/:spaces:${this.order.receiver.spaceURLId}/${this.order.receiver.id}/SpaceWallet?hash=${this.order.refundTransactionHash}&principal=true`}return null},orderLink(){return this.order&&`${eXo.env.portal.context}/${eXo.env.portal.portalName}/perkstore?productId=${this.order.productId}&orderId=${this.order.id}`||"#"},productLink(){return this.order&&`${eXo.env.portal.context}/${eXo.env.portal.portalName}/perkstore?productId=${this.order.productId}`||"#"},productTitle(){return this.orderProduct&&this.orderProduct.title||this.order&&this.order.productTitle||""},userData(){return this.orderProduct&&this.orderProduct.userData||{}},createdDateLabel(){return F(this.order.createdDate)},deliveredDateLabel(){return F(this.order.deliveredDate)},refundedDateLabel(){return F(this.order.refundedDate)},deliveredPercentageColor(){return(this.order.deliveredQuantity?this.order.refundedQuantity&&"orange":"grey")||"teal"},deliveredPercentage(){return parseInt(100*this.order.deliveredQuantity/this.order.quantity)},statusLowerCase(){return this.order.status&&this.order.status.toLowerCase()},isError(){return"error"===this.statusLowerCase},isPaid(){return"paid"===this.statusLowerCase},isDelivered(){return"delivered"===this.statusLowerCase},isRefunded(){return"refunded"===this.statusLowerCase},isCanceled(){return"canceled"===this.statusLowerCase},isOrdered(){return"ordered"===this.statusLowerCase},isPartial(){return"partial"===this.statusLowerCase},isBuyer(){return this.order&&this.order.sender&&this.order.sender.id===eXo.env.portal.userName},canDeliverOrder(){return this.order.remainingQuantityToProcess&&this.order.remainingQuantityToProcess>0&&(this.isPaid||this.isPartial)},canRefundOrder(){return this.refunding||this.order.remainingQuantityToProcess&&(0===this.order.refundedQuantity||"FAILED"===this.order.refundTransactionStatus)&&this.order.remainingQuantityToProcess>0&&(this.isPaid||this.isPartial)&&("space"===this.order.receiver.type||this.order.receiver.id===eXo.env.portal.userName)}},created(){this.getProductById()},methods:{openProductDetail(e){e.stopPropagation(),e.preventDefault(),this.$emit("display-product",this.order.productId)},refunded(){},refundDrawerClosed(){this.$emit("init-wallet"),this.refunding=!1},changeStatus(e){return u({id:this.order.id,productId:this.order.productId,status:e||this.order.status},"STATUS").then((e=>{this.$emit("changed",e),this.$forceUpdate()})).catch((e=>{console.error("Error saving status",e),this.$emit("error",e&&e.message?e.message:String(e))}))},getProductById(){var e;(e=this.order.productId,fetch(`/portal/rest/perkstore/api/product/${e}`,{method:"GET",credentials:"include"}).then((t=>{if(t&&t.ok)return t.json();throw new Error("Error getting product with id",e)}))).then((e=>{e&&(this.orderProduct=e)})).catch((e=>{console.error("Error getting product",e),this.$emit("error",e&&e.message?e.message:String(e))}))}}},L,[],!1,null,null,null).exports;var E=function(){var e=this,t=e._self._c;return t("v-snackbar",{staticClass:"notificationParent",attrs:{timeout:12e4,color:"black"},model:{value:e.snackbar,callback:function(t){e.snackbar=t},expression:"snackbar"}},[t("v-card",{staticClass:"transparent",attrs:{dark:""}},[e._l(e.filteredOrders,(function(r){return[t("v-card-text",{key:r.id,staticClass:"text-truncate notificationContent",attrs:{dark:""}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.label.newOrderFrom",{0:r.id,1:r.sender.displayName}))+"\n      ")]),e._v(" "),e.displayDivider?t("v-divider",{key:r.id,attrs:{dark:""}}):e._e()]})),e._v(" "),t("v-card-actions",[t("v-spacer"),e._v(" "),t("v-btn",{attrs:{title:e.$t("exoplatform.perkstore.button.refresh"),dark:""},on:{click:e.refreshList}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.refresh"))+"\n      ")]),e._v(" "),t("v-spacer")],1)],2),e._v(" "),t("v-btn",{staticClass:"ms-0",attrs:{dark:"",icon:""},on:{click:e.close}},[t("v-icon",{attrs:{dark:""}},[e._v("close")])],1)],1)};E._withStripped=!0;const N=i({props:{orders:{type:Array,default:function(){return[]}}},data:()=>({snackbar:!1,snackbarDisplayed:[]}),computed:{displayDivider(){return this.orders&&this.orders.length>1},filteredOrders(){return this.orders.filter((e=>this.snackbarDisplayed.indexOf(e.id)<0)).slice(0,Math.min(3,this.orders.length))}},watch:{snackbar(){this.snackbar||this.orders.forEach((e=>this.snackbarDisplayed.push(e.id)))},orders(){this.snackbar=!!this.orders.filter((e=>this.snackbarDisplayed.indexOf(e.id)<0)).length}},methods:{refreshList(){this.$emit("refresh-list")},close(){this.snackbar=!1}}},E,[],!1,null,null,null).exports;var T=function(){var e=this,t=e._self._c;return t("exo-drawer",{ref:"ordersFilterDrawer",staticClass:"productOrderFilter",attrs:{right:!e.$vuetify.rtl}},[t("template",{slot:"title"},[t("span",{staticClass:"mx-2"},[e._v(" "+e._s(e.$t("exoplatform.perkstore.label.filterOrders"))+" ")])]),e._v(" "),t("template",{slot:"content"},[t("v-container",{staticClass:"border-box-sizing pe-1 productOrderFilterContent",attrs:{"grid-list-xl":""}},[t("v-layout",{attrs:{wrap:"",column:""}},[t("h4",[t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.searchInDates")},model:{value:e.filter.searchInDates,callback:function(t){e.$set(e.filter,"searchInDates",t)},expression:"filter.searchInDates"}})],1),e._v(" "),e.filter.searchInDates?[t("v-divider"),e._v(" "),t("v-date-picker",{staticClass:"border-box-sizing",attrs:{type:"date"},model:{value:e.selectedDate,callback:function(t){e.selectedDate=t},expression:"selectedDate"}})]:e._e(),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.notCompletelyProcessed")},model:{value:e.filter.notProcessed,callback:function(t){e.$set(e.filter,"notProcessed",t)},expression:"filter.notProcessed"}}),e._v(" "),e.filter.notProcessed?e._e():[t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.ordered")},model:{value:e.filter.ordered,callback:function(t){e.$set(e.filter,"ordered",t)},expression:"filter.ordered"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.canceled")},model:{value:e.filter.canceled,callback:function(t){e.$set(e.filter,"canceled",t)},expression:"filter.canceled"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.error")},model:{value:e.filter.error,callback:function(t){e.$set(e.filter,"error",t)},expression:"filter.error"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.paid")},model:{value:e.filter.paid,callback:function(t){e.$set(e.filter,"paid",t)},expression:"filter.paid"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.partial")},model:{value:e.filter.partial,callback:function(t){e.$set(e.filter,"partial",t)},expression:"filter.partial"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.delivered")},model:{value:e.filter.delivered,callback:function(t){e.$set(e.filter,"delivered",t)},expression:"filter.delivered"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.refunded")},model:{value:e.filter.refunded,callback:function(t){e.$set(e.filter,"refunded",t)},expression:"filter.refunded"}}),e._v(" "),t("v-checkbox",{attrs:{label:e.$t("exoplatform.perkstore.label.status.fraud")},model:{value:e.filter.fraud,callback:function(t){e.$set(e.filter,"fraud",t)},expression:"filter.fraud"}})]],2)],1)],1),e._v(" "),t("template",{slot:"footer"},[t("div",{staticClass:"VuetifyApp flex d-flex"},[t("v-btn",{staticClass:"reset",on:{click:e.reset}},[[t("i",{staticClass:"fas fa-redo"}),e._v("\n          "+e._s(e.$t("exoplatform.perkstore.button.reset"))+"\n        ")]],2),e._v(" "),t("v-spacer"),e._v(" "),t("v-btn",{staticClass:"btn mx-1",attrs:{title:e.$t("exoplatform.perkstore.button.cancel")},on:{click:e.closeFilters}},[t("span",[e._v(e._s(e.$t("exoplatform.perkstore.button.cancel")))])]),e._v(" "),t("v-btn",{staticClass:"btn btn-primary",attrs:{title:e.$t("exoplatform.perkstore.button.save")},on:{click:e.saveFilter}},[t("span",[e._v(e._s(e.$t("exoplatform.perkstore.button.save")))])])],1)])],2)};T._withStripped=!0;const q=i({props:{filter:{type:Object,default:function(){return{}}}},data:()=>({display:!1,selectedDate:null}),watch:{selectedDate(){this.selectedDate?this.filter.selectedDate=new Date(this.selectedDate).getTime():this.filter.selectedDate=0}},created(){this.selectedDate=this.filter&&this.filter.selectedDate?new Date(this.filter.selectedDate).toISOString().split("T")[0]:null},methods:{searchOrders(){this.$emit("search"),this.closeFilters()},saveFilter(){var e;e=this.filter,localStorage.setItem("exo-perkstore-order-filter",JSON.stringify(e)),this.searchOrders()},showFilters(){this.$refs.ordersFilterDrawer.open()},closeFilters(){this.$refs.ordersFilterDrawer.close()},reset(){this.filter.canceled=!0,this.filter.delivered=!0,this.filter.error=!0,this.filter.fraud=!0,this.filter.ordered=!0,this.filter.paid=!0,this.filter.partial=!0,this.filter.refunded=!0,this.filter.selectedOrderId=null,this.filter.selectedDate=null,this.filter.searchInDates=!1,this.filter.notProcessed=!1,this.saveFilter()}}},T,[],!1,null,null,null).exports;var B=function(){var e=this,t=e._self._c;return t("v-layout",{staticClass:"border-box-sizing me-0 ms-0",attrs:{row:""}},[t("perk-store-orders-filter",{ref:"productOrdersFilter",attrs:{filter:e.ordersFilter},on:{search:e.searchOrders}}),e._v(" "),t("v-container",{staticClass:"productOrdersParent border-box-sizing mt-0",attrs:{fluid:"","grid-list-xs":""}},[!e.selectedOrderId&&e.displayFilterDetails&&e.filterDescriptionLabels&&e.filterDescriptionLabels.length?t("v-card",{staticClass:"transparent mb-0 mt-0 pt-0",attrs:{flat:""}},[t("v-card-title",{staticClass:"mt-0 pt-0"},[t("v-spacer"),e._v(" "),t("div",{staticClass:"no-wrap text-truncate"},[e._v("\n          "+e._s(e.$t("exoplatform.perkstore.label.selectedFilter"))+":\n          "),e._l(e.filterDescriptionLabels,(function(r){return t("v-chip",{key:r},[e._v("\n            "+e._s(e.$t(`exoplatform.perkstore.label.status.${r}`))+"   "),"date"==r?[e._v(" : "+e._s(e.selectedDate)+" ")]:e._e()],2)}))],2),e._v(" "),t("v-spacer")],1)],1):e._e(),e._v(" "),t("a",{staticClass:"hidden",attrs:{id:"downloadOrders"}},[e._v(e._s(e.$t("exoplatform.perkstore.button.download")))]),e._v(" "),t("v-layout",{staticClass:"OrdersListParent",attrs:{row:"",wrap:""}},[e.filteredOrders&&e.filteredOrders.length?e._l(e.filteredOrders,(function(r){return t("div",{key:r.id,staticClass:"flex perkStoreDetailContent border-box-sizing"},[t("perk-store-order-detail",{ref:`orderDetail${r.id}`,refInFor:!0,attrs:{order:r,product:e.product,symbol:e.symbol},on:{"init-wallet":function(t){return e.$emit("init-wallet")},"display-product":function(t){return e.$emit("display-product",t)},changed:function(t){return e.updateOrder(r,t)},loading:function(t){return e.$emit("loading",t)},error:function(t){return e.$emit("error",t)}}})],1)})):e.search?t("div",{staticClass:"ma-auto"},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.noOrdersSearchResultFor",{0:e.search}))+"\n      ")]):e.walletEnabled?t("perk-store-no-result",{attrs:{info:e.$t("exoplatform.perkstore.info.welcomeToPerkstore"),"click-condition":e.walletEnabled,icon:"fas fa-cart-plus","info-message":"exoplatform.perkstore.info.rewardsPerkstoreNoOrdersSummary"},on:{"no-result-event":function(t){return e.$emit("no-order-redirect",t)}}}):e._e()],2),e._v(" "),e.loading||e.displayLoadMoreButton?t("v-flex",{staticClass:"mt-2 me-6 text-center elevation-2",attrs:{slot:"footer",dense:"",flat:""},slot:"footer"},[e.displayLoadMoreButton?t("v-btn",{staticClass:"primary--text",attrs:{text:"",loading:e.loading,disabled:e.loading},on:{click:e.loadMore}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.loadMore"))+"\n      ")]):e.loading?t("v-progress-circular",{staticClass:"mb-2",attrs:{color:"primary",indeterminate:""}}):e._e()],1):e._e(),e._v(" "),t("perk-store-order-notification",{attrs:{orders:e.newAddedOrders},on:{"refresh-list":e.addNewOrdersToList}})],1)],1)};B._withStripped=!0;const U=i({props:{product:{type:Object,default:function(){return{}}},ordersFilter:{type:Object,default:function(){return{}}},selectedOrderId:{type:Number,default:function(){return 0}},symbol:{type:String,default:function(){return""}},search:{type:String,default:function(){return""}},filterOrder:{type:String,default:function(){return"all"}},walletEnabled:{type:Boolean,default:!1}},data:()=>({loading:!1,pageSize:12,limit:12,limitReached:!1,filterDescriptionLabels:[],displayFilterDetails:!1,orders:[],newAddedOrders:[],initialLimit:0,selectedDate:""}),computed:{selectedOrdersFilter(){return!this.selectedOrderId&&this.ordersFilter||{ordered:!0,canceled:!0,error:!0,paid:!0,partial:!0,delivered:!0,refunded:!0,fraud:!0}},filteredOrders(){const e=this.selectedOrderId&&this.orders.find((e=>e&&e.id===this.selectedOrderId));return e?[e]:this.search?this.orders.filter((e=>e.sender&&e.sender.displayName&&e.sender.displayName.toLowerCase().indexOf(this.search.trim().toLowerCase())>=0)).slice(0,this.initialLimit):this.orders.slice(0,this.limit)},displayLoadMoreButton(){return!this.limitReached&&this.orders.length&&this.orders.length%this.pageSize==0}},watch:{product(e,t){!e||t&&e.id===t.id||(this.limit=12,this.limitReached=!1,this.newAddedOrders=[],this.init())},search(){this.filterOrdersByFullTextSearchField()},filterOrder(){this.init()}},created(){this.init(),document.addEventListener("exo.perkstore.order.createOrModify",this.updateOrderFromWS)},methods:{init(){this.$emit("error",null),this.computeDisplayFilterDetails(),this.computeDescriptionLabels();const e=this.orders.length>this.limit?this.limit-1:this.orders.length;return this.loading=!0,this.selectedOrdersFilter.ordersType=this.filterOrdersType(),d(this.product&&this.product.id,this.selectedOrdersFilter,this.selectedOrderId,this.limit).then((e=>(this.orders=e||[],this.$nextTick()))).then((()=>{this.limitReached&&(this.limitReached=this.orders.length<=e||this.orders.length<this.limit)})).catch((e=>{console.error("Error while listing orders",e),this.$emit("error",e&&e.message?e.message:String(e))})).finally((()=>{this.loading=!1}))},filterOrdersByFullTextSearchField(){if(!this.loading){if(this.initialLimit){if(!this.search)return this.limit=this.initialLimit,this.init()}else this.initialLimit=this.limit;return this.loading=!0,this.$emit("search-loading"),this.searchOrdersFromServer().finally((()=>{this.$emit("end-search-loading"),this.loading=!1}))}},searchOrdersFromServer(){const e=this;return this.$nextTick().then((()=>{if(!e.limitReached&&e.filteredOrders.length>e.initialLimit)return e.increaseLimitAndloadMore(!0)})).then((()=>e.$nextTick())).then((()=>{if(!e.limitReached&&e.filteredOrders.length>e.initialLimit)return e.searchOrdersFromServer()}))},searchOrders(){return this.init()},computeDisplayFilterDetails(){if(this.displayFilterDetails=!1,!this.selectedOrdersFilter)return void(this.displayFilterDetails=!1);if(this.selectedOrdersFilter.notProcessed)return void(this.displayFilterDetails=!0);if(this.selectedOrdersFilter.searchInDates&&this.selectedOrdersFilter.selectedDate)return void(this.displayFilterDetails=!0);const e={ordered:this.selectedOrdersFilter.ordered,canceled:this.selectedOrdersFilter.canceled,paid:this.selectedOrdersFilter.paid,partial:this.selectedOrdersFilter.partial,delivered:this.selectedOrdersFilter.delivered,refunded:this.selectedOrdersFilter.refunded,fraud:this.selectedOrdersFilter.fraud};this.displayFilterDetails=!Object.values(e).every((e=>e))},computeDescriptionLabels(){var e;this.filterDescriptionLabels=[],this.selectedOrdersFilter.searchInDates&&this.selectedOrdersFilter.selectedDate&&(this.selectedDate=(e=this.selectedOrdersFilter.selectedDate)?`${new Date(e).toLocaleDateString(eXo.env.portal.language,{year:"numeric",month:"long",day:"numeric"})}`:"-",this.filterDescriptionLabels.push("date")),this.selectedOrdersFilter.notProcessed?this.filterDescriptionLabels.push("notProcessed"):(this.selectedOrdersFilter.ordered&&this.filterDescriptionLabels.push("ordered"),this.selectedOrdersFilter.canceled&&this.filterDescriptionLabels.push("canceled"),this.selectedOrdersFilter.error&&this.filterDescriptionLabels.push("error"),this.selectedOrdersFilter.paid&&this.filterDescriptionLabels.push("paid"),this.selectedOrdersFilter.partial&&this.filterDescriptionLabels.push("partial"),this.selectedOrdersFilter.delivered&&this.filterDescriptionLabels.push("delivered"),this.selectedOrdersFilter.refunded&&this.filterDescriptionLabels.push("refunded"),this.selectedOrdersFilter.fraud&&this.filterDescriptionLabels.push("fraud"))},showFilters(){this.$refs.productOrdersFilter.showFilters()},updateOrder(e,t,r){r||(r=this.orders),Object.assign(e,t)},loadMore(){return this.increaseLimitAndloadMore()},increaseLimitAndloadMore(e){return this.limit+=this.pageSize,e||(this.initialLimit=this.limit),this.init()},updateOrderFromWS(e){const t=e.detail;if(this.orders&&this.orders.length&&t.productorder&&t.productorder.id){const e=this.orders.find((e=>e&&e.id===t.productorder.id));e?(this.updateOrder(e,t.productorder),this.updateOrder(e,t.productorder,this.newAddedOrders)):this.product&&t.productorder.productId===this.product.id&&(this.product.userData&&this.product.userData.canEdit?"ORDERED"!==t.productorder.status.toUpperCase()||this.newAddedOrders.find((e=>e.id===t.productorder.id))||this.newAddedOrders.unshift(t.productorder):this.orders.unshift(t.productorder))}},addNewOrdersToList(){this.newAddedOrders.reverse().forEach((e=>{this.orders.find((t=>t.id===e.id))||this.orders.unshift(e)})),this.newAddedOrders.splice(0,this.newAddedOrders.length)},exportOrders(){return d(this.product&&this.product.id,this.selectedOrdersFilter,this.selectedOrderId,0).then((e=>{if(!e||!e.length)return;e.reverse();const t={id:this.$t("exoplatform.perkstore.label.orderId"),sender:{displayName:this.$t("exoplatform.perkstore.label.buyer")},receiver:{displayName:this.$t("exoplatform.perkstore.label.seller")},status:this.$t("exoplatform.perkstore.label.status"),quantity:this.$t("exoplatform.perkstore.label.quantity"),deliveredQuantity:this.$t("exoplatform.perkstore.label.deliveredQuantity"),refundedQuantity:this.$t("exoplatform.perkstore.label.refundedQuantity"),amount:this.$t("exoplatform.perkstore.label.amount"),refundedAmount:this.$t("exoplatform.perkstore.label.refundedAmount"),createdDate:this.$t("exoplatform.perkstore.label.orderDate"),deliveredDate:this.$t("exoplatform.perkstore.label.deliveredDate"),refundedDate:this.$t("exoplatform.perkstore.label.refundedDate")};e.unshift(t);const r=`data:text/csv;charset=utf-8,${e=e.map((e=>[e.id,e.sender&&e.sender.displayName,e.receiver&&e.receiver.displayName,e.status,e.quantity,e.deliveredQuantity,e.refundedQuantity,`${e.amount} ${this.symbol}`,`${e.refundedAmount} ${this.symbol}`,e.createdDate&&e.createdDate!==t.createdDate?F(e.createdDate):e.createdDate||"-",e.deliveredDate&&e.deliveredDate!==t.deliveredDate?F(e.deliveredDate):e.deliveredDate||"-",e.refundedDate&&e.refundedDate!==t.refundedDate?F(e.refundedDate):e.refundedDate||"-"])).map((e=>e.join(","))).join("\n")}`,s=document.getElementById("downloadOrders");s.setAttribute("href",r),s.setAttribute("download","orders.csv"),s.click()}))},filterOrdersType(){const e="SENT",t="RECEIVED";return this.filterOrder===t?t:this.filterOrder===e?e:"ALL"}}},B,[],!1,null,null,null).exports;var R=function(){var e=this,t=e._self._c;return e.integrated?t("v-flex",{staticClass:"ms-4"},[t("div",{staticClass:"headline mb-4"},[e._v("\n    "+e._s(e.product.title)+"\n    "),e.product.receiverMarchand?t("div",{staticClass:"d-flex align-center"},[t("span",{staticClass:"caption me-2"},[e._v(e._s(e.$t("exoplatform.perkstore.label.offeredBy")))]),e._v(" "),t("exo-user-avatar",{attrs:{"profile-id":e.product.receiverMarchand.id,fullname:"","link-style":"",popover:""}})],1):e._e()]),e._v(" "),e.product.description?t("div",{staticClass:"mb-4 me-4"},[e._v("\n    "+e._s(e.product.description)+"\n  ")]):e._e()]):t("v-list",{staticClass:"grey lighten-4 pt-0 pb-0 productPreviewContent",attrs:{dense:"",light:"",transparent:""}},[e.product.enabled?e.product.unlimited||e.available?e.maxOrdersReached?t("v-list-item",[t("v-list-item-content",{staticClass:"align-center"},[t("strong",{staticClass:"red--text"},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.label.maxOrdersIsReached",{0:e.product.maxOrdersPerUser}))+"\n      ")])])],1):e._e():t("v-list-item",{staticClass:"soldOutBlock red"},[t("v-list-item-content",{staticClass:"align-center"},[t("strong",{staticClass:"white--text"},[e._v("Sold out")])])],1):t("v-list-item",{attrs:{light:""}},[t("v-list-item-content",{staticClass:"align-center"},[t("strong",{staticClass:"red--text"},[e._v("Disabled product")])])],1),e._v(" "),t("v-expand-transition",[e.hover?t("div",[e.product.receiverMarchand?t("div",[t("span",{staticClass:"caption me-2"},[t("strong",[e._v(e._s(e.$t("exoplatform.perkstore.label.offeredBy"))+":")])]),e._v(" "),t("v-list-item-content",{staticClass:"productDetailText align-end"},[t("div",{staticClass:"text-truncate"},[t("exo-user-avatar",{attrs:{"profile-id":e.product.receiverMarchand.id,"link-style":"",popover:""}})],1)])],1):e._e(),e._v(" "),e.product.unlimited&&e.userData.canEdit?t("v-list-item",[t("v-list-item-content",[t("strong",[e._v(e._s(e.$t("exoplatform.perkstore.label.sold"))+":")])]),e._v(" "),t("v-list-item-content",{staticClass:"align-end"},[e._v(e._s(e.product.purchased))])],1):e.product.unlimited?e._e():t("v-list-item",[t("v-list-item-content",[t("strong",[e._v(e._s(e.$t("exoplatform.perkstore.label.available"))+":")])]),e._v(" "),e.userData.canEdit?t("v-list-item-content",{staticClass:"align-end"},[e._v(e._s(e.available)+" / "+e._s(e.product.totalSupply))]):t("v-list-item-content",{staticClass:"align-end"},[e._v(e._s(e.available))])],1),e._v(" "),!e.maxOrdersReached&&e.product.maxOrdersPerUser?[t("v-divider"),e._v(" "),t("v-list-item",[t("v-list-item-content",[t("strong",[e._v(e._s(e.$t("exoplatform.perkstore.label.myOrders"))+":")])]),e._v(" "),e.product.orderPeriodicity?[e.userData.purchasedInCurrentPeriod?t("v-list-item-content",{staticClass:"align-end"},[e._v("\n              "+e._s(e.$t(`exoplatform.perkstore.label.ordersInThis${e.product.orderPeriodicity}`,{0:e.userData.purchasedInCurrentPeriod,1:e.product.maxOrdersPerUser}))+"\n            ")]):t("v-list-item-content",{staticClass:"align-end"},[e._v("\n              "+e._s(e.$t(`exoplatform.perkstore.label.ordersPerUserPer${e.product.orderPeriodicity}`,{0:e.product.maxOrdersPerUser}))+"\n            ")])]:[e.userData.totalPurchased?t("v-list-item-content",{staticClass:"align-end"},[e._v("\n              "+e._s(e.userData.totalPurchased)+"/"+e._s(e.product.maxOrdersPerUser)+"\n            ")]):t("v-list-item-content",{staticClass:"align-end"},[e._v("\n              "+e._s(e.$t("exoplatform.perkstore.label.ordersPerUser",{0:e.product.maxOrdersPerUser}))+"\n            ")])]],2)]:e._e()],2):e._e()])],1)};R._withStripped=!0;const Q=i({props:{product:{type:Object,default:function(){return{}}},symbol:{type:String,default:function(){return""}},available:{type:Number,default:function(){return 0}},maxOrdersReached:{type:Boolean,default:function(){return!1}},hover:{type:Boolean,default:function(){return!1}},integrated:{type:Boolean,default:function(){return!1}}},computed:{userData(){return this.product&&this.product.userData||{}}}},R,[],!1,null,null,null).exports;var j=function(){var e=this,t=e._self._c;return e.hasNewProducts?t("v-alert",{attrs:{type:"success",dismissible:""},model:{value:e.alert,callback:function(t){e.alert=t},expression:"alert"}},[e._l(e.filteredProducts,(function(t){return[t.lastModifiedDate?[e._v("\n      "+e._s(e.$t("exoplatform.perkstore.info.productModified",{0:t.title}))+"\n    ")]:[e._v("\n      "+e._s(e.$t("exoplatform.perkstore.info.productCreated",{0:t.title}))+"\n    ")]]}))],2):e._e()};j._withStripped=!0;const z=i({props:{products:{type:Array,default:function(){return[]}}},data:()=>({alert:!1,alertDisplayed:[]}),computed:{displayDivider(){return this.products&&this.products.length>1},hasNewProducts(){return this.products&&this.products.find((e=>!e.lastModifiedDate))},filteredProducts(){return this.products.filter((e=>this.alertDisplayed.indexOf(e.id)<0)).slice(0,Math.min(3,this.products.length))}},watch:{alert(){this.alert||(this.$emit("refresh-list"),this.products.forEach((e=>this.alertDisplayed.push(e.id))))},products(){window.setTimeout((()=>this.alert=!1),5e3),this.alert=this.products.filter((e=>this.alertDisplayed.indexOf(e.id)<0)).length}}},j,[],!1,null,null,null).exports;var W=function(){var e=this,t=e._self._c;return t("v-card",{staticClass:"d-flex flex-column border-radius box-shadow",attrs:{flat:"","min-height":"227"}},[t("div",{staticClass:"d-flex flex-grow-1 pa-0"},[e.hasImages?t("v-img",{staticClass:"primary--text",attrs:{src:e.imageSrc,"aspect-ratio":"1","min-height":"70px","min-width":"70px",height:"100%",width:"100%","max-height":"153px","max-width":"224px"}}):t("v-icon",{staticClass:"primary--text ma-auto",attrs:{size:"70"}},[e._v("\n      fa-images\n    ")])],1),e._v(" "),t("v-list",{staticClass:"light-grey-background flex-grow-0 border-top-color no-border-radius pa-0"},[t("v-list-item",{staticClass:"px-0 pt-1 pb-2",attrs:{href:e.productLink}},[t("v-list-item-icon",{staticClass:"mx-0 my-auto"},[t("span",{staticClass:"uiIconHandbag tertiary--text ps-1 pe-2 display-1"})]),e._v(" "),t("v-list-item-content",[t("v-list-item-title",{attrs:{title:e.result.title}},[e._v("\n          "+e._s(e.result.title)+"\n        ")]),e._v(" "),t("v-list-item-subtitle",[e._v("\n          "+e._s(e.result.price)+"\n          "),t("span",{staticClass:"tertiary-color"},[e._v(e._s(e.symbol))])])],1)],1)],1)],1)};W._withStripped=!0;const X=i({props:{term:{type:String,default:null},result:{type:Object,default:null}},data:()=>({symbol:null}),computed:{productLink(){return this.result&&`${eXo.env.portal.context}/${eXo.env.portal.portalName}/perkstore?productId=${this.result.id}`},hasImages(){return this.result&&this.result.imageFiles&&this.result.imageFiles.length},imageSrc(){return this.hasImages&&this.result.imageFiles[0].src}},created(){this.symbol=window.walletSettings&&window.walletSettings.contractDetail&&window.walletSettings.contractDetail.symbol,document.addEventListener("exo-wallet-init-result",(e=>{this.symbol=e&&e.detail&&e.detail.symbol}))}},W,[],!1,null,null,null).exports;var V=function(){var e=this,t=e._self._c;return t("v-alert",{attrs:{type:e.alertType,dismissible:"",icon:"warning"===e.alertType?"mdi-alert-circle":""},model:{value:e.displayAlert,callback:function(t){e.displayAlert=t},expression:"displayAlert"}},[t("span",{directives:[{name:"sanitized-html",rawName:"v-sanitized-html",value:e.alertMessage,expression:"alertMessage"}]})])};V._withStripped=!0;const H=i({data:()=>({displayAlert:!1,alertMessage:null,alertType:null}),created(){this.$root.$on("show-alert",(e=>{this.alertMessage=e.message,this.alertType=e.type,this.displayAlert=!0,window.setTimeout((()=>this.displayAlert=!1),5e3)}))}},V,[],!1,null,null,null).exports;var G=function(){var e=this,t=e._self._c;return t("exo-drawer",{ref:"refundForm",attrs:{right:!e.$vuetify.rtl}},[t("template",{slot:"title"},[t("div",{staticClass:"titleBuyProductDrawer"},[e._v(e._s(e.$t("exoplatform.perkstore.title.refundOrderModal",{0:e.order&&e.order.id})))])]),e._v(" "),t("template",{slot:"content"},[t("div",{staticClass:"pa-4 pt-0",attrs:{flat:""}},[t("div",[!e.warning||e.loading||e.walletLoading?e._e():t("div",{staticClass:"alert alert-warning v-content ma-5"},[t("i",{staticClass:"uiIconWarning"}),e._v("\n          "+e._s(e.warning)+"\n        ")]),e._v(" "),e.isInternalWallet&&e.error&&!e.loading?t("div",{staticClass:"alert alert-error v-content ma-5"},[t("i",{staticClass:"uiIconError"}),e._v("\n          "+e._s(e.error)+"\n        ")]):e._e(),e._v(" "),t("v-form",{ref:"form",attrs:{id:"refundFormProduct"},model:{value:e.validForm,callback:function(t){e.validForm=t},expression:"validForm"}},[t("v-row",{staticClass:"ml-2 mr-2"},[t("v-col",{staticClass:"d-flex align-center ml-n5",attrs:{cols:"12",sm:"6"}},[t("label",{staticClass:"font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.quantity")))])]),e._v(" "),t("v-col",{attrs:{cols:"12",sm:"6",align:"right"}},[t("v-text-field",{staticClass:"text-center pt-1 mr-n10 quantity",attrs:{disabled:e.loading,label:e.quantityInputLabel,placeholder:e.$t("exoplatform.perkstore.label.refundQuantityPlaceholder"),rules:e.requiredNumberRule,"append-icon":"fa-plus","prepend-inner-icon":"fa-minus",name:"quantity",required:""},on:{"click:prepend-inner":e.decrementQuantity,"click:append":e.incrementQuantity},model:{value:e.quantity,callback:function(t){e.quantity=e._n(t)},expression:"quantity"}})],1)],1),e._v(" "),t("label",{staticClass:"font-weight-bold"},[e._v(e._s(e.$t("exoplatform.perkstore.label.amount")))]),e._v(" "),t("v-row",{staticClass:"ml-0 mr-0"},[t("v-text-field",{staticClass:"text-left mt-n3",attrs:{disabled:e.loading,placeholder:e.$t("exoplatform.perkstore.label.refundAmountPlaceholder"),rules:e.requiredAmountRule,name:"amount",autofocus:"",required:""},model:{value:e.amount,callback:function(t){e.amount=e._n(t)},expression:"amount"}})],1),e._v(" "),e.needPassword&&!e.storedPassword&&e.isInternalWallet?t("label",{staticClass:"font-weight-bold mt-4"},[e._v(e._s(e.$t("exoplatform.wallet.label.walletPassword")))]):e.isInternalWallet?e._e():t("label",{staticClass:"font-weight-bold mt-2"},[e._v(e._s(e.$t("exoplatform.wallet.label.settings.internal")))]),e._v(" "),e.isInternalWallet?e._e():t("v-row",{staticClass:"ml-2"},[t("v-col",{staticClass:"d-flex align-center ml-n5",attrs:{cols:"12",sm:"6"}},[t("img",{staticClass:"mt-n1",attrs:{src:"/wallet-common/images/metamask.svg",alt:"Metamask",width:"18"}}),e._v(" "),t("span",{staticClass:"pl-2 amountLabel"},[e._v(e._s(e.$t("exoplatform.wallet.label.metamask")))])]),e._v(" "),t("v-col",{attrs:{cols:"12",sm:"6",align:"right"}},[t("v-chip",{staticClass:"grey-background mr-n5"},[t("span",{staticClass:"mr-3 dark-grey-color walletTitle"},[e._v("\n                  "+e._s(e.metamaskAddressPreview)+"\n                ")]),e._v(" "),t("wallet-settings-jdenticon",{attrs:{address:e.walletAddress}})],1)],1)],1),e._v(" "),e.needPassword&&!e.storedPassword&&e.isInternalWallet?t("v-text-field",{ref:"walletPassword",staticClass:"ma-0",attrs:{"append-icon":e.walletPasswordShow?"mdi-eye":"mdi-eye-off",type:e.walletPasswordShow?"text":"password",disabled:e.loading,rules:e.mandatoryRule,placeholder:e.$t("exoplatform.wallet.label.walletPasswordPlaceholder"),name:"walletPassword",required:"","validate-on-blur":"",autocomplete:"current-password"},on:{"click:append":function(t){e.walletPasswordShow=!e.walletPasswordShow}},model:{value:e.walletPassword,callback:function(t){e.walletPassword=t},expression:"walletPassword"}}):e._e()],1)],1)])]),e._v(" "),t("template",{slot:"footer"},[e.displayMetamaskWarnings?t("div",[t("wallet-metamask-warnings",{attrs:{"not-installed":!e.metamaskInstalled,"not-connected":!e.metamaskConnected,"invalid-network":e.invalidMetamaskNetwork,"invalid-account":e.invalidMetamaskAccount}})],1):t("div",{staticClass:"d-flex mr-2"},[t("v-spacer"),e._v(" "),t("button",{staticClass:"ignore-vuetify-classes btn",attrs:{disabled:e.loading||e.walletLoading},on:{click:e.close}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.close"))+"\n      ")]),e._v(" "),t("button",{staticClass:"ignore-vuetify-classes btn btn-primary mx-1",attrs:{disabled:!e.validForm||e.loading||e.walletLoading},on:{click:e.refundProduct}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.refund"))+"\n      ")])],1)])],2)};G._withStripped=!0;const J={"perk-store-auto-complete":a,"perk-store-buy-form":p,"perk-store-no-result":m,"perk-store-buy-modal":v,"perk-store-products-list":y,"perk-store-product-detail":w,"perk-store-product-form":k,"perk-store-create-product-button":C,"perk-store-deliver-modal":D,"perk-store-upload-input":I,"perk-store-image-attachment-selector":A,"perk-store-order-detail":M,"perk-store-order-notification":N,"perk-store-orders-filter":q,"perk-store-orders-list":U,"perk-store-product-detail-content":Q,"perk-store-product-notification":z,"perk-store-product-search-card":X,"perk-store-alert":H,"perk-store-refund-drawer":i({props:{product:{type:Object,default:function(){return{}}},order:{type:Object,default:function(){return{}}},symbol:{type:String,default:function(){return null}}},data(){return{resultError:null,drawer:!1,walletAddonInstalled:!1,walletLoading:!1,walletEnabled:!1,validForm:!1,needPassword:!1,loading:!1,quantity:null,amount:null,walletPassword:"",walletPasswordShow:!1,warning:null,error:null,requiredRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField")],requiredNumberRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField"),e=>this.isPositiveNumber(e,!0)||this.$t("exoplatform.perkstore.warning.invalidPositiveNumber"),e=>!this.order||this.quantity<=Number(this.order.remainingQuantityToProcess)||this.$t("exoplatform.perkstore.warning.maxQuantityReached",{0:this.remainingQuantityToProcess})],requiredAmountRule:[e=>!!e||this.$t("exoplatform.perkstore.warning.requiredField"),e=>this.isPositiveNumber(e,!1)||this.$t("exoplatform.perkstore.warning.invalidPositiveNumber"),e=>e<=this.maxAmount||this.$t("exoplatform.perkstore.warning.maxAmountReached",{0:this.maxAmount})],metamaskAddress:null,metamaskNetworkId:null,metamaskConnected:!1}},created(){this.walletAddonInstalled=window.walletAddonInstalled,document.addEventListener("exo-wallet-send-tokens-pending",this.pendingTransaction),document.addEventListener("exo-wallet-send-tokens-error",this.errorTransaction),document.addEventListener("exo-wallet-init-result",this.walletInitialized),document.addEventListener("wallet-metamask-accountsChanged",this.updateSelectedMetamaskAddress),document.addEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskNetworkId),document.addEventListener("wallet-metamask-connected",this.updateSelectedMetamaskInformation),document.addEventListener("wallet-metamask-disconnected",this.updateSelectedMetamaskInformation)},beforeDestroy(){document.removeEventListener("wallet-metamask-accountsChanged",this.updateSelectedMetamaskAddress),document.removeEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskNetworkId),document.removeEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskInformation),document.removeEventListener("wallet-metamask-chainChanged",this.updateSelectedMetamaskInformation)},methods:{isPositiveNumber(e,t){return e=Number(e),this.product&&e&&e>0&&Number.isFinite(e)&&(!t||Number.isSafeInteger(e))},walletInitialized(e){this.walletLoading=!1;const t=e&&e.detail;!t||t.error?(this.resultError=t&&t.error?`${t.error}`:this.$t("exoplatform.perkstore.warning.walletNotConfiguredProperly"),this.warning=`${this.resultError}`,this.walletEnabled=!1):(this.walletEnabled=!0,this.needPassword=t.needPassword)},incrementQuantity(){this.quantity=this.quantity&&this.quantity+1>0?this.quantity+1:1,this.quantity=Math.floor(this.quantity)},decrementQuantity(){this.quantity=this.quantity&&this.quantity-1>0?this.quantity-1:0,this.quantity=Math.floor(this.quantity)},pendingTransaction(e){const t=e.detail;if(this.drawer&&this.loading)return this.$emit("refunding"),u({id:this.order.id,productId:this.order.productId,refundTransactionHash:t.hash,refundedQuantity:Number(this.quantity),refundedAmount:Number(this.amount)},"REFUNDED_QUANTITY").then((e=>{this.$emit("refunded",e),this.loading=!1,this.drawer=!1})).then(this.showAlert("success",this.$t("exoplatform.wallet.metamask.message.transactionSent"),this.order.transactionHash)).catch((e=>{console.error("Error saving refund order",e),this.loading=!1,this.drawer=!1,this.error=e&&e.message?e.message:String(e)}))},errorTransaction(e){this.loading=!1,this.error=e.detail},refundProduct(e){if(this.error=null,e.preventDefault(),e.stopPropagation(),!this.$refs.form.validate())return!1;if(!this.isPositiveNumber(this.quantity,!0))return void(this.error=this.$t("exoplatform.perkstore.warning.invalidQuantity"));if(!this.isPositiveNumber(this.amount))return void(this.error=this.$t("exoplatform.perkstore.warning.invalidAmount"));if(this.quantity>this.order.remainingQuantityToProcess)return void(this.error=this.$t("exoplatform.perkstore.warning.cantRefundMoreThanQuantity",{0:this.order.remainingQuantityToProcess}));if(this.amount>this.quantity*this.product.price)return void(this.error=this.$t("exoplatform.perkstore.warning.amountGreaterThanRealPrice"));if(!this.order.sender)return void(this.error=this.$t("exoplatform.perkstore.warning.orderWithoutSenderWallet"));this.loading=!0;const t=this.$t("exoplatform.perkstore.info.refundedQuantityAndAmount",{0:this.product.title,1:this.quantity,2:this.product.price,3:this.symbol||""});if(this.isInternalWallet)document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens",{detail:{amount:this.amount,receiver:this.order.sender,sender:this.order.receiver,password:this.walletPassword,label:t,message:t}}));else if(window.ethereum?.isMetaMask)return s(this.order.sender.id,this.order.sender.type).then((e=>{this.$emit("opened-transaction",!0);const r={to:this.contractDetails.address,from:this.walletAddress,data:this.contractDetails.contract.methods.transfer(e.address,this.DecimalsAmount).encodeABI()};window.ethereum.request({method:"eth_sendTransaction",params:[r]}).then((r=>this.transactionUtils.saveTransactionDetails({contractAddress:this.contractDetails.address,contractAmount:this.amount,contractMethodName:"transfer",from:this.walletAddress,label:t,message:t,pending:!0,hash:r,timestamp:Date.now(),to:e.address}))).then((e=>{document.dispatchEvent(new CustomEvent("exo-wallet-send-tokens-pending",{detail:e})),this.showAlert("success",this.$t("exoplatform.wallet.metamask.message.transactionSent"),e.hash),this.$emit("close"),this.close()})).catch((e=>{this.$emit("opened-transaction",!1),e&&4001===e.code||(console.error("Checking order availability error",e),this.showAlert("error",this.$t("exoplatform.wallet.metamask.error.transactionFailed")))})).finally((()=>this.loading=!1))}))},showAlert(e,t,r){this.$root.$emit("wallet-notification-alert",{type:e,message:t,transactionHash:r})},open(){this.isMetamaskWallet&&this.updateSelectedMetamaskInformation(),this.drawer=!0,this.$refs.refundForm.open()},close(){this.$refs.refundForm.close()},updateSelectedMetamaskNetworkId(){this.metamaskNetworkId=window.walletSettings.metamask?.networkId},updateSelectedMetamaskAddress(){this.metamaskAddress=window.walletSettings.metamask?.address},updateSelectedMetamaskInformation(){this.metamaskInstalled=window.walletSettings.metamask?.installed,this.metamaskConnected=window.walletSettings.metamask?.connected,this.updateSelectedMetamaskNetworkId(),this.updateSelectedMetamaskAddress()}},computed:{amountInputLabel(){return this.order&&this.$t("exoplatform.perkstore.label.amountWithMax",{0:this.maxAmount})},quantityInputLabel(){return this.order&&this.$t("exoplatform.perkstore.label.quantityWithMax",{0:this.order.remainingQuantityToProcess})},maxAmount(){return this.order&&this.product&&n(this.order.remainingQuantityToProcess*this.product.price)||0},productTitle(){return this.product&&this.product.title||this.order.productTitle||""},walletAddress:()=>window.walletSettings.wallet.address,invalidMetamaskAccount(){return!this.metamaskAddress||(this.metamaskAddress||"").toLowerCase()!==(this.walletAddress||"").toLowerCase()},invalidMetamaskNetwork(){return this.metamaskNetworkId!==window.walletSettings?.network?.id},displayMetamaskWarnings(){return this.isMetamaskWallet&&(this.invalidMetamaskNetwork||this.invalidMetamaskAccount||!this.metamaskConnected)},metamaskAddressPreview(){return this.walletAddress&&`${this.walletAddress.substring(0,5)}...${this.walletAddress.substring(this.walletAddress.length-4,this.walletAddress.length)}`},isInternalWallet:()=>"INTERNAL_WALLET"===window.walletSettings.wallet?.provider,isMetamaskWallet:()=>"METAMASK"===window.walletSettings.wallet?.provider,contractDetails(){return this.tokenUtils.getContractDetails(this.walletAddress)},DecimalsAmount(){return this.walletUtils.convertTokenAmountToSend(this.amount,this.contractDetails.decimals)}},watch:{quantity(){this.quantity?this.amount=this.product&&this.product.price&&this.quantity&&n(this.quantity*this.product.price)||0:this.amount=0},error(){this.error&&(this.loading=!1)},drawer(){this.drawer?(this.walletLoading=!0,this.walletEnabled=!1,document.dispatchEvent(new CustomEvent("exo-wallet-init",{detail:{sender:this.order.receiver}})),this.quantity=this.order&&this.order.remainingQuantityToProcess,this.warning=null,this.error=null,this.loading=!1,this.walletPassword="",this.walletPasswordShow=!1):this.$emit("closed")}}},G,[],!1,null,null,null).exports};for(const e in J)Vue.component(e,J[e]);function Z(e,t){return e&&e.length&&(e=e.filter((e=>e.title&&e.title.toLowerCase().indexOf(t.toLowerCase())>=0||e.description&&e.description.toLowerCase().indexOf(t.toLowerCase())>=0))),e}return $(document).ready((()=>{window.walletAddonInstalled&&document.dispatchEvent(new CustomEvent("exo-wallet-init"))})),t})()));