define((()=>(()=>{"use strict";var e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{init:()=>m});var s=function(){var e=this,t=e._self._c;return t("v-app",[t("v-card",{staticClass:"border-radius settingsModal",attrs:{flat:""}},[t("div",{staticClass:"ignore-vuetify-classes popupHeader ClearFix titleSettings mt-3"},[t("span",{staticClass:"ignore-vuetify-classes PopupTitle popupTitle text-truncate titlePerkStoreAdmin"},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.title.settingsModal"))+"\n      ")])]),e._v(" "),t("v-card-text",{staticClass:"perkStoreSettings"},[e.alert?t("exo-notification-alert",{attrs:{alert:e.alert},on:{dismissed:e.clear}}):e._e(),e._v(" "),t("perk-store-auto-complete",{ref:"applicationAccessPermissionAutocomplete",attrs:{"input-label":e.$t("exoplatform.perkstore.label.applicationAccessPermissions"),"input-placeholder":e.$t("exoplatform.perkstore.label.applicationAccessPermissionsPlaceholder"),"no-data-label":e.$t("exoplatform.perkstore.label.applicationAccessPermissionsSearchPlaceholder"),multiple:"","no-address":"","big-field":""},on:{"item-selected":function(t){return e.selectValue("accessPermissionsProfiles",t)},"clear-selection":function(t){return e.selectValue("accessPermissionsProfiles")}}}),e._v(" "),t("perk-store-auto-complete",{ref:"applicationManagersAutocomplete",attrs:{"input-label":e.$t("exoplatform.perkstore.label.applicationManagersPermissions"),"input-placeholder":e.$t("exoplatform.perkstore.label.applicationManagersPermissionsPlaceholder"),"no-data-label":e.$t("exoplatform.perkstore.label.applicationManagersPermissionsSearchPlaceholder"),multiple:"","no-address":"","big-field":""},on:{"item-selected":function(t){return e.selectValue("managersProfiles",t)},"clear-selection":function(t){return e.selectValue("managersProfiles")}}}),e._v(" "),t("perk-store-auto-complete",{ref:"applicationProductCreationPermissionAutocomplete",attrs:{"input-label":e.$t("exoplatform.perkstore.label.applicationCreationPermissions"),"input-placeholder":e.$t("exoplatform.perkstore.label.applicationCreationPermissionsPlaceholder"),"no-data-label":e.$t("exoplatform.perkstore.label.applicationCreationPermissionsSearchPlaceholder"),multiple:"","no-address":"","big-field":""},on:{"item-selected":function(t){return e.selectValue("productCreationPermissionsProfiles",t)},"clear-selection":function(t){return e.selectValue("productCreationPermissionsProfiles")}}})],1),e._v(" "),t("v-card-actions",{staticClass:"mb-2"},[t("v-spacer"),e._v(" "),t("v-btn",{staticClass:"primary me-1",attrs:{disabled:e.disablePayButton,loading:e.loading},on:{click:e.saveSettings}},[e._v("\n        "+e._s(e.$t("exoplatform.perkstore.button.save"))+"\n      ")]),e._v(" "),t("v-spacer")],1)],1)],1)};function i(e,t){if(!e||!e.ok){const s=e&&e.headers&&e.headers.get("content-type");if(s&&-1!==s.indexOf("application/json"))return e.json().then((e=>{const s=function(e,t){return e&&e.code&&e.suffix&&e.message?e.message:t}(e,t);throw new Error(s)}))}throw new Error(t)}function r(e,t,s,i,r,o,n,a){var l,c="function"==typeof e?e.options:e;if(t&&(c.render=t,c.staticRenderFns=s,c._compiled=!0),i&&(c.functional=!0),o&&(c._scopeId="data-v-"+o),n?(l=function(e){(e=e||this.$vnode&&this.$vnode.ssrContext||this.parent&&this.parent.$vnode&&this.parent.$vnode.ssrContext)||"undefined"==typeof __VUE_SSR_CONTEXT__||(e=__VUE_SSR_CONTEXT__),r&&r.call(this,e),e&&e._registeredComponents&&e._registeredComponents.add(n)},c._ssrRegister=l):r&&(l=a?function(){r.call(this,(c.functional?this.parent:this).$root.$options.shadowRoot)}:r),l)if(c.functional){c._injectStyles=l;var d=c.render;c.render=function(e,t){return l.call(t),d(e,t)}}else{var u=c.beforeCreate;c.beforeCreate=u?[].concat(u,l):[l]}return{exports:e,options:c}}s._withStripped=!0;const o=r({data:()=>({dialog:!1,loading:!1,settingsToSave:{},alert:null}),watch:{dialog(){this.dialog?(this.alert=null,this.loading=!1,this.$nextTick().then(this.init)):this.$emit("closed")}},created(){this.dialog=!0,this.alert=null},methods:{open(){this.dialog=!0},close(){this.loading||(this.dialog=!1)},init(){return fetch("/portal/rest/perkstore/api/settings",{credentials:"include"}).then((e=>e&&e.ok?e.json():i(e,"Error getting settings"))).then((e=>(function(e){const t=window.location;cCometd.configure({url:`${t.protocol}//${t.hostname}${t.port?":":""}${t.port||""}/${e.userSettings.cometdContext}/cometd`,exoId:eXo.env.portal.userName,exoToken:e.userSettings.cometdToken}),cCometd.subscribe(e.userSettings.cometdChannel,null,(e=>{const t=e.data&&JSON.parse(e.data);document.dispatchEvent(new CustomEvent(t.eventId,{detail:t&&t.message}))}))}(e=window.perkStoreSettings=Object.assign({},e)),e))).then((()=>{this.settingsToSave=Object.assign({},window.perkStoreSettings),this.settingsToSave&&(this.$refs.applicationAccessPermissionAutocomplete.clear(),this.settingsToSave.accessPermissionsProfiles&&this.$refs.applicationAccessPermissionAutocomplete.selectItems(this.settingsToSave.accessPermissionsProfiles),this.$refs.applicationManagersAutocomplete.clear(),this.settingsToSave.managersProfiles&&this.$refs.applicationManagersAutocomplete.selectItems(this.settingsToSave.managersProfiles),this.$refs.applicationProductCreationPermissionAutocomplete.clear(),this.settingsToSave.productCreationPermissionsProfiles&&this.$refs.applicationProductCreationPermissionAutocomplete.selectItems(this.settingsToSave.productCreationPermissionsProfiles))}))},selectValue(e,t){this.settingsToSave[e]||(this.settingsToSave[e]=[]),t?this.settingsToSave[e].push(t):this.settingsToSave[e].length&&(this.settingsToSave[e]=[])},saveSettings(){return this.loading=!0,this.alert=null,function(e){if(e)return fetch("/portal/rest/perkstore/api/settings/save",{credentials:"include",method:"POST",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(e)}).then((e=>{if(!e||!e.ok)return i(e,"Error saving settings")}));throw new Error("Error saving empty settings",e)}(this.settingsToSave).then((()=>{this.$emit("saved"),this.dialog=!1,this.loading=!1,this.alert={message:this.$t("exoplatform.perkstore.admin.settings.success"),type:"success"}})).catch((e=>{console.error("Save settings error",e),this.loading=!1,this.alert={message:this.$t("exoplatform.perkstore.admin.settings.error",{0:e&&e.message?e.message:String(e)}),type:"error"}}))}}},s,[],!1,null,null,null).exports;var n=function(){var e=this,t=e._self._c;return t("v-flex",{staticClass:"contactAutoComplete",attrs:{id:e.id}},[t("v-autocomplete",{ref:"selectAutoComplete",staticClass:"contactAutoComplete",attrs:{rules:e.rules,items:e.items,loading:e.isLoadingSuggestions,"search-input":e.searchTerm,label:e.inputLabel,disabled:e.disabled,placeholder:e.inputPlaceholder,"content-class":`contactAutoCompleteContent ${e.bigField&&"bigContactAutoComplete"}`,filter:e.filterIgnoredItems,multiple:e.multiple,required:e.required,"max-width":"100%","item-text":"name","item-value":"id_type","hide-details":"","hide-selected":"",chips:"","cache-items":"",dense:"",flat:""},on:{"update:searchInput":function(t){e.searchTerm=t},"update:search-input":[function(t){e.searchTerm=t},function(t){e.searchTerm=t}],click:function(e){e.stopPropagation()}},scopedSlots:e._u([{key:"selection",fn:function({item:s,selected:i}){return[s.avatar?t("v-chip",{staticClass:"autocompleteSelectedItem",attrs:{"input-value":i,title:"error"===e.addressLoad?e.$t("exoplatform.perkstore.warning.recipientDoesntHaveWallet"):""},on:{"update:active":function(t){return e.selectSingleItem(s)}}},["loading"===e.addressLoad?t("v-progress-circular",{staticClass:"me-2",attrs:{indeterminate:"",color:"white"}}):"error"===e.addressLoad?t("v-icon",{staticClass:"me-2",attrs:{alt:"Invalid address",color:"red",size:"15"}},[e._v("\n          warning\n        ")]):e._e(),e._v(" "),t("span",[e._v("\n          "+e._s(s.name)+"\n          "),t("a",{staticClass:"remove",attrs:{href:"#",title:e.$t("exoplatform.perkstore.button.delete")},on:{click:function(t){return e.remove(s)}}},[t("i",{staticClass:"uiIconClose uiIconLightGray"})])])],1):t("v-label",{staticClass:"black--text",attrs:{selected:i,solo:""},on:{input:function(t){return e.selectSingleItem(s)}}},[e._v("\n        "+e._s(s.name)+"\n        "),t("a",{staticClass:"remove",attrs:{href:"#"}},[t("i",{staticClass:"uiIconClose uiIconLightGray"})])])]}},{key:"item",fn:function(s){return["object"!=typeof s.item?[t("v-list-item-content",{domProps:{textContent:e._s(s.item)}})]:s.item.avatar?t("v-list-item-avatar",{attrs:{size:"20"}},[t("img",{attrs:{src:s.item.avatar,alt:e.$t("exoplatform.perkstore.img.alt",{0:s.item.name})}})]):e._e(),e._v(" "),t("v-list-item-title",{domProps:{textContent:e._s(s.item.name)}})]}}]),model:{value:e.selectedValue,callback:function(t){e.selectedValue=t},expression:"selectedValue"}},[t("template",{slot:"no-data"},[t("v-list-item",[e.noDataLabel?t("v-list-item-title",[e._v("\n          "+e._s(e.noDataLabel)+"\n        ")]):t("v-list-item-title",[e._v("\n          "+e._s(e.$t("exoplatform.perkstore.label.autocompletePlaceholder"))+"\n        ")])],1)],1)],2)],1)};function a(e,t){return fetch(`/portal/rest/wallet/api/account/detailsById?id=${e}&type=${t}`,{credentials:"include"}).then((e=>e&&e.ok?e.json():null))}n._withStripped=!0;const l={"perk-store-admin":o,"perk-store-auto-complete":r({props:{rules:{type:Array,default:function(){return[]}},required:{type:Boolean,default:function(){return!1}},inputLabel:{type:String,default:function(){return null}},inputPlaceholder:{type:String,default:function(){return null}},noDataLabel:{type:String,default:function(){return null}},noAddress:{type:Boolean,default:function(){return!1}},onlyUsers:{type:Boolean,default:function(){return!1}},multiple:{type:Boolean,default:function(){return!1}},disabled:{type:Boolean,default:function(){return!1}},bigField:{type:Boolean,default:function(){return!1}},ignoreItems:{type:Array,default:function(){return[]}}},data:()=>({items:[],id:`AutoComplete${parseInt(1e4*Math.random()).toString().toString()}`,selectedValue:null,searchTerm:null,address:null,isLoadingSuggestions:!1,addressLoad:"",currentUserItem:null,error:null}),watch:{searchTerm(e){if(e&&e.length)return this.isLoadingSuggestions=!0,function(e,t){let s=null;return function(e,t){const s=$.param({nameToSearch:e,typeOfRelation:"mention_activity_stream",currentUser:eXo.env.portal.userName,spaceURL:window.perkStoreSettings&&window.perkStoreSettings.accessPermission&&window.perkStoreSettings.accessPermission.length?window.perkStoreSettings.accessPermission:null});return fetch(`/portal/rest/social/people/suggest.json?${s}`,{credentials:"include"}).then((e=>e.ok?e.json():null)).then((e=>(e?(e.options&&(e=e.options),e.forEach((e=>{e.id&&0===e.id.indexOf("@")&&(e.id=e.id.substring(1),e.id_type=`user_${e.id}`,e.avatar||(e.avatar=e.avatarUrl?e.avatarUrl:`/rest/v1/social/users/${e.id}/avatar`))}))):e=[],e)))}(e).then((e=>s=e&&e.length?e:[])).then((()=>t&&[]||function(e,t){const s=$.param({fields:["id","prettyName","displayName","avatarUrl"],keyword:e});return fetch(`/portal/rest/space/user/searchSpace?${s}`,{credentials:"include"}).then((e=>e.ok?e.json():null)).then((e=>{const t=[];return e.forEach((e=>{t.push({avatar:e.avatarUrl?e.avatarUrl:`/portal/rest/v1/social/spaces/${e.prettyName}/avatar`,name:e.displayName,id:e.prettyName,id_type:`space_${e.prettyName}`,technicalId:e.id,members:null})})),t}))}(e))).then((e=>s=e&&e.length?s.concat(e):s)).catch((e=>{console.error("searchContact method - error",e)}))}(e,this.onlyUsers).then((e=>{this.items=e,this.items?this.currentUserItem&&this.items.push(this.currentUserItem):this.currentUserItem?this.items=[this.currentUserItem]:this.items=[]})).finally((()=>{this.isLoadingSuggestions=!1}));this.currentUserItem?this.items=[this.currentUserItem]:this.items=[]},selectedValue(){this.$refs.selectAutoComplete.isFocused=!1,this.addressLoad="loading";const e=this.selectedValue;this.$emit("clear-selection"),e&&e.length&&(this.multiple?e.forEach((e=>this.emitSelectedValue(e))):this.emitSelectedValue(e))}},created(){a(eXo.env.portal.userName,"user").then((e=>{e&&(e.id_type=`${e.type}_${e.id}`,this.currentUserItem=e)}))},mounted(){window.addEventListener("click",(()=>{this.$refs.selectAutoComplete&&this.$refs.selectAutoComplete.blur()}))},methods:{emitSelectedValue(e){const t=e.indexOf("_")<0,s=t?null:e.substring(0,e.indexOf("_")),i=t?e:e.substring(e.indexOf("_")+1);if(!this.noAddress)return t?function(e){if(e){e=e.toLowerCase();try{const t=sessionStorage.getItem(`exo-wallet-address-user-${e}`.toLowerCase())||sessionStorage.getItem(`exo-wallet-address-space-${e}`.toLowerCase());if(t)return Promise.resolve(JSON.parse(t))}catch(e){console.error("Error getting item from session storage")}return fetch(`/portal/rest/wallet/api/account/detailsByAddress?address=${e}`,{credentials:"include"}).then((e=>e.ok?e.json():null)).then((t=>{if(t&&t.name&&t.name.length)return t.avatar||(t.avatar="user"===t.type?`/rest/v1/social/users/${t.id}/avatar`:`/rest/v1/social/spaces/${t.id}/avatar`),!t.id_type&&t.type&&t.id&&(t.id_type=`${t.type}_${t.id}`),sessionStorage.setItem(`exo-wallet-address-${t.type}-${e}`.toLowerCase(),JSON.stringify(t)),t})).catch((e=>{console.error("searchFullName method - error",e)}))}}(e).then((e=>{e&&e.type?(this.addressLoad="success",this.$emit("item-selected",{id:e.id,type:e.type,address:e.address,id_type:`${e.type}_${e.id}`})):(this.addressLoad="success",this.$emit("item-selected",{id:i,type:s,address:i}))})):function(e,t){const s=sessionStorage.getItem(`exo-wallet-address-${t}-${e}`.toLowerCase());return s?Promise.resolve(s):a(e,t).then((s=>s&&s.address&&s.address.length&&0===s.address.indexOf("0x")?(sessionStorage&&sessionStorage.setItem(`exo-wallet-address-${t}-${e}`.toLowerCase(),s.address),s.address):(sessionStorage.removeItem(`exo-wallet-address-${t}-${e}`.toLowerCase()),null)))}(i,s).then((e=>{e&&e.length?(this.addressLoad="success",this.$emit("item-selected",{id:i,type:s,address:e})):(this.addressLoad="error",this.$emit("item-selected",{id:i,type:s,address:null}))})).catch((e=>{console.error("searchAddress method - error",e),this.addressLoad="error"}));this.addressLoad="success",this.$emit("item-selected",{id:i,type:s,address:i})},clear(){this.currentUserItem?this.items=[this.currentUserItem]:this.items=[],this.selectedValue=null,this.searchTerm=null,this.address=null,this.isLoadingSuggestions=!1,this.addressLoad="",this.error=null},canAddItem(e){return!e||!e.id||this.ignoreItems.indexOf(e.id)<0},filterIgnoredItems(e,t,s){return!(t&&s.toLowerCase().indexOf(t.toLowerCase())<0)&&(!this.ignoreItems||!this.ignoreItems.length||this.canAddItem(e))},selectItems(e){e&&(e.splice?e.forEach((e=>{e&&e.id&&e.type&&this.selectSingleItem(e.id,e.type)})):e.id&&e.type&&this.selectSingleItem(e.id,e.type))},selectSingleItem(e,t){if(e){if(t)return a(e,t).then((e=>{e.id_type=e.type&&e.id?`${e.type}_${e.id}`:null,this.items.push(e),this.$refs.selectAutoComplete&&this.$refs.selectAutoComplete.selectItem(e)}));{const t={id_type:e,name:e};this.items.push(t),this.$refs.selectAutoComplete&&this.$refs.selectAutoComplete.selectItem(t)}}else this.$refs.selectAutoComplete.selectItem(null)},remove(e){if(this.selectedValue)if(this.selectedValue.splice){const t=this.selectedValue.indexOf(e.id_type);t>=0&&this.selectedValue.splice(t,1)}else this.selectedValue=null}}},n,[],!1,null,null,null).exports};for(const e in l)Vue.component(e,l[e]);if(extensionRegistry){const e=extensionRegistry.loadComponents("PerkStoreAdmin");e&&e.length>0&&e.forEach((e=>{Vue.component(e.componentName,e.componentOptions)}))}document.dispatchEvent(new CustomEvent("displayTopBarLoading")),Vue.use(Vuetify);const c=new Vuetify(eXo.env.portal.vuetifyPreset),d=eXo&&eXo.env&&eXo.env.portal&&eXo.env.portal.language||"en",u=`${eXo.env.portal.context}/${eXo.env.portal.rest}/i18n/bundle/locale.addon.PerkStore-${d}.json`,p="PerkStoreAdminApp";function m(){exoi18n.loadLanguageAsync(d,u).then((e=>{new Vue({mounted(){document.dispatchEvent(new CustomEvent("hideTopBarLoading"))},template:`<perk-store-admin id="${p}" />`,i18n:e,vuetify:c}).$mount(`#${p}`)}))}return t})()));